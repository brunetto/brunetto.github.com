<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    GIF2 substructures coordinates correction // Post It!
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="Brunetto Ziosi">

  <meta property="og:title" content="GIF2 substructures coordinates correction" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://brunettoziosi.eu/posts/gif2-substructures-coordinates-correction/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="http://brunettoziosi.eu/css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.svg">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Post It!" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

    <h1 class="brand-title">Post It!</h1>
    <h2 class="brand-tagline">Sticky digital notes
    </br>stuck on the Web!😃</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="http://brunettoziosi.eu">Home</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/posts/">Blog</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/pages/curriculum-vitae/">CV</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/pages/">Pages</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="http://www.twitter.com/brunettoziosi" target="_blank"><i class='fa fa-twitter'></i></a>
        
      
        
        <a href="http://plus.google.com/&#43;BrunettoZiosi" target="_blank"><i class='fa fa-google-plus'></i></a>
        
      
        
        <a href="http://www.github.com/brunetto" target="_blank"><i class='fa fa-github'></i></a>
        
      
        
        <a href="http://www.facebook.com/brunettoziosi" target="_blank"><i class='fa fa-facebook'></i></a>
        
      
        
        <a href="http://www.linkedin.com/in/brunettoziosi" target="_blank"><i class='fa fa-linkedin'></i></a>
        
      
        
        <a href="https://instagram.com/elbrunz/" target="_blank"><i class='fa fa-instagram'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/posts/gif2-substructures-coordinates-correction/">GIF2 substructures coordinates correction</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>4</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Dec</span> <span class="post-date-year">2011</span>
            	</span>
            	
            
            
            
            
            	
            		<span class="post-author-single">By <a class="post-author" href="http://brunettoziosi.eu" target="">Brunetto Ziosi</a></span>
            		




            	
            
            

			
			
				<div class="post-categories">
				
					<a class="post-category post-category-research" href="http://brunettoziosi.eu/categories/research">Research</a>
				
					<a class="post-category post-category-python" href="http://brunettoziosi.eu/categories/python">Python</a>
				
					<a class="post-category post-category-programming" href="http://brunettoziosi.eu/categories/programming">Programming</a>
				
					<a class="post-category post-category-post" href="http://brunettoziosi.eu/categories/post">Post</a>
				
				</div>
			

			
		    	<div class="social-sharing">
	<a class="share-button-facebook" onClick="return popupShare(this.href);" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fgif2-substructures-coordinates-correction%2f" target="_blank"><i class="fa fa-facebook"><span>Like</span></i></a>
	<a class="share-button-google-plus" onClick="return popupShare(this.href);" href="https://plus.google.com/share?url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fgif2-substructures-coordinates-correction%2f" target="_blank"><i class="fa fa-google-plus"><span>Google +1</span></i></a>
	<a class="share-button-linkedin" onClick="return popupShare(this.href);" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fgif2-substructures-coordinates-correction%2f&title=GIF2%20substructures%20coordinates%20correction&summary=I%20used%20this%20script%20to%20change%20the%20coordinates%20of%20the%20substructures%20in%20the%20GIF2%20simulation%20output%20from%20the%20center%20of%20mass%20coordinates%20to%20the%20global%20ones.%20The%20substructures%20were%20stored%20in%20our%20server%20in%20files%20referring%20to%20the%20index%20of%20the%20halo%20to%20which%20they%20belong%20and%20their%20coordinates%20were%20respect%20to%20the%20center%20of%20the%20halo.%20For%20each%20halo%20this%20script%20read%20the%20subhaloes%20center%20of%20mass%20coordinates%20in%20kpc%20and%20change%20them%20to%20global%20coordinates%20in%20Mpc%20managing%20the%20periodic%20boundary%20conditions%20.}&source=Post%20It%21" target="_blank"><i class="fa fa-linkedin"><span>Share on LinkedIn</span></i></a>
	<a class="share-button-twitter" onClick="return popupShare(this.href);" href="http://twitter.com/share?text=GIF2%20substructures%20coordinates%20correction&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fgif2-substructures-coordinates-correction%2f" target="_blank"><i class="fa fa-twitter"><span>Tweet</span></i></a>	
</div>
		    

			

            <p>I used this script to change the coordinates of the substructures in the GIF2 simulation output from the center of mass coordinates to the global ones. The substructures were stored in our server in files referring to the index of the halo to which they belong and their coordinates were respect to the center of the halo. For each halo this script read the subhaloes center of mass coordinates in kpc and change them to global coordinates in Mpc managing the periodic boundary conditions .</p>

<!-- TEASER_END -->    

<pre><code class="language-python">#!/usr/bin/env python
import numpy as np
import tables as tb
import time
import sys

&quot;&quot;&quot;Legge il file con id e centri degli aloni con sottostrutture, per
ogni alone (id) apre il file Sub.3..053.gv, legge le coordinate
alle colonne 8, 9, 10 (in kpc!!!) e le corregge (tenendo conto delle
condizioni periodiche) con le coordinate del centro prese dalla lista
degli aloni iniziale.  Le coordinate vengono aggiunte ad un vettore
che alla fine viene salvato in un file hdf5.
&quot;&quot;&quot;

t = time.time()
print &quot;Start&quot;
</code></pre>

<p>As usual: imports, documentation and timing initialization.</p>

<pre><code class="language-python">halo_centers_file = 'haloes_with_substructures_centers.h5'

h5 = tb.openFile(halo_centers_file, 'r')
haloes = h5.root.data.read()
h5.close()

haloes = haloes.astype(float)
</code></pre>

<p>This piece of code reads the halo centers from a file.</p>

<pre><code class="language-python">substructure_coord = np.empty((0, 3))
files_num = haloes[:, 0].shape[0]
void_files = 0
</code></pre>

<p>Here we create the first (void) record of the substructures coordinates table, find the number of haloes and create a variable which will tell us how many haloes without subtructures we have.</p>

<p>Now, for each halo we</p>

<pre><code class="language-python">for i in xrange(files_num):
    print &quot;Loop &quot;, i, &quot; di &quot;, files_num 
    sub_file = &quot;cm/Sub.3.&quot;+'%07d'%int(haloes[i,0])+&quot;.053.gv&quot;
    ````
    
open the related substructures file     
````python
try:
        sub_coord = np.genfromtxt(sub_file, dtype='float', usecols=(8, 9, 10))
        file_check = True
    except:
        print &quot;Void file &quot;, sub_file
        file_check = False
        void_files += 1
</code></pre>

<p>try to read the substructures coordinates, if it fails, we assume that the file is empty (and the halo has no substructures). In this case we increment the counter of the empy files.</p>

<pre><code class="language-python">if file_check:
        if sub_coord.ndim == 1:
            sub_coord = sub_coord.reshape((1, sub_coord.shape[0]))
            #print &quot;sh min &quot;, np.amin(sub_coord, 0)
            #print &quot;sh min &quot;, np.amax(sub_coord, 0)
</code></pre>

<p>This reshape the array in case we have only one subhalo: in this case (I hope I remember correct!:P) instead of one row and three columns we should have three values, so we have to reshape the array to pass it to the rest of the code.</p>

<pre><code class="language-python">try:
            sub_x = sub_coord[:, 0]/1000. + haloes[i,1]
            if not np.all(sub_x &amp;gt; 0):
                sub_x[sub_x&amp;lt;0]+=110 # condizioni periodiche
            if not np.all(sub_x 110]-=110
            if not (np.all(sub_x &amp;gt; 0) and np.all(sub_x  0)
                print sub_x 
                print haloes[i, 1:3]
                sys.exit()
            sub_y = sub_coord[:, 1]/1000. + haloes[i,2]
            if not np.all(sub_y &amp;gt; 0):
                sub_y[sub_y&amp;lt;0]+=110 # condizioni periodiche
            if not np.all(sub_y 110]-=110
            if not (np.all(sub_y &amp;gt; 0) and np.all(sub_y  0)
                print sub_y
                print haloes[i, 1:3]
                sys.exit()
            sub_z = sub_coord[:, 2]/1000. + haloes[i,3]
            if not np.all(sub_z &amp;gt; 0):
                sub_z[sub_z&amp;lt;0]+=110 # condizioni periodiche
            if not np.all(sub_z 110]-=110
            if not (np.all(sub_z &amp;gt; 0) and np.all(sub_z  0)
                print sub_z 
                print haloes[i, 1:3]
                sys.exit()
            substructure_coord = np.vstack((substructure_coord, np.hstack((sub_x.reshape((sub_x.shape[0], 1)), 
                                                                           sub_y.reshape((sub_y.shape[0], 1)), 
                                                                           sub_z.reshape((sub_z.shape[0], 1))))))
</code></pre>

<p>This corrects the coordinates keeping in mind the periodic boundary conditions and add the new substructures coordinates to the corrected substructures array.</p>

<pre><code class="language-python">except:
            print &quot;file &quot;, sub_file
            print &quot;sub_coord.shape &quot;, sub_coord.shape
            print &quot;sub_coord &quot;, sub_coord
            print &quot;haloes coord &quot;, haloes[i, :]
            print &quot;exit&quot;
            sys.exit()
    else:
        pass
</code></pre>

<p>If something goes wrong, we handle the failure printing some information.</p>

<pre><code class="language-python">h5 = tb.openFile('sub_haloes_global_coords.h5', 'w')
h5.createArray(h5.root, 'data', substructure_coord)
h5.flush()
h5.close()
print &quot;Done in &quot;, time.time()-t, &quot; with &quot;, void_files, &quot; void files&quot;
</code></pre>

<p>In the end, we save the array in an HDF5 file!:)</p>

	
			
		    	<div class="social-sharing">
	<a class="share-button-facebook" onClick="return popupShare(this.href);" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fgif2-substructures-coordinates-correction%2f" target="_blank"><i class="fa fa-facebook"><span>Like</span></i></a>
	<a class="share-button-google-plus" onClick="return popupShare(this.href);" href="https://plus.google.com/share?url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fgif2-substructures-coordinates-correction%2f" target="_blank"><i class="fa fa-google-plus"><span>Google +1</span></i></a>
	<a class="share-button-linkedin" onClick="return popupShare(this.href);" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fgif2-substructures-coordinates-correction%2f&title=GIF2%20substructures%20coordinates%20correction&summary=I%20used%20this%20script%20to%20change%20the%20coordinates%20of%20the%20substructures%20in%20the%20GIF2%20simulation%20output%20from%20the%20center%20of%20mass%20coordinates%20to%20the%20global%20ones.%20The%20substructures%20were%20stored%20in%20our%20server%20in%20files%20referring%20to%20the%20index%20of%20the%20halo%20to%20which%20they%20belong%20and%20their%20coordinates%20were%20respect%20to%20the%20center%20of%20the%20halo.%20For%20each%20halo%20this%20script%20read%20the%20subhaloes%20center%20of%20mass%20coordinates%20in%20kpc%20and%20change%20them%20to%20global%20coordinates%20in%20Mpc%20managing%20the%20periodic%20boundary%20conditions%20.}&source=Post%20It%21" target="_blank"><i class="fa fa-linkedin"><span>Share on LinkedIn</span></i></a>
	<a class="share-button-twitter" onClick="return popupShare(this.href);" href="http://twitter.com/share?text=GIF2%20substructures%20coordinates%20correction&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fgif2-substructures-coordinates-correction%2f" target="_blank"><i class="fa fa-twitter"><span>Tweet</span></i></a>	
</div>
		    

			
				<div class="tags-list">
					<span class="dark-red">Tags</span><span class="decorative-marker">//</span>
					
	                <a class="post-tag post-tag-astro/physics" href="http://brunettoziosi.eu/tags/astro/physics">astro/physics</a>,
	                
	                <a class="post-tag post-tag-cosmic-structure" href="http://brunettoziosi.eu/tags/cosmic-structure">cosmic structure</a>,
	                
	                <a class="post-tag post-tag-cosmology" href="http://brunettoziosi.eu/tags/cosmology">Cosmology</a>,
	                
	                <a class="post-tag post-tag-phd" href="http://brunettoziosi.eu/tags/phd">PhD</a>,
	                
				</div>
			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="/posts/gif2-files-python-reader/">GIF2 files Python reader</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/posts/from-binaries-to-hdf5-using-python/">From binaries to HDF5 using Python</a>
		            </div>
		            
	            </div>
            
          </section>
          

          	<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = "brunettoziosieu";   
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>
	<p>&copy; 2015 
	<a href="https://plus.google.com/117554238100031566866?rel=author">Brunetto Ziosi</a>. All rights reserved. </br>
	Theme by <a href="https://github.com/tmaiaroto/hugo-redlounge">Tom Maiaroto</a>, Generated (with ❤) using <a href="http://gohugo.io/">Hugo.</a></p>
</div>

    </div>
  </div>
	

	
		<script type="text/javascript">
			function popupShare(url) {
				window.open(url, '_blank', 'scrollbars,resizable,height=525,width=600');
				return false;
			}
		</script>
	

  
  <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML&delayStartupUntil=configured" type="text/javascript"></script>
    <script type="text/javascript">
    
    MathJax.Hub.Config({
      tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js"]
      }
    });
    MathJax.Hub.Queue(function() {
      $(MathJax.Hub.getAllJax()).map(function(index, elem) {
        return(elem.SourceElement());
      }).parent().addClass('has-jax');
    });
    MathJax.Hub.Configured();
    </script>
</body>
</html>
