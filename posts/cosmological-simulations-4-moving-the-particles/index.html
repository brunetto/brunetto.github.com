<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    Cosmological simulations: #4: Moving the particles! // Post It!
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="Brunetto Ziosi">

  <meta property="og:title" content="Cosmological simulations: #4: Moving the particles!" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://brunettoziosi.eu/posts/cosmological-simulations-4-moving-the-particles/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="http://brunettoziosi.eu/css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Post It!" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

    <h1 class="brand-title">Post It!</h1>
    <h2 class="brand-tagline">Sticky digital notes        stuck on the Web!ðŸ˜ƒ</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="http://brunettoziosi.eu">Home</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/posts/">Blog</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/pages/curriculum-vitae/">CV</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/pages/">Pages</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="http://www.facebook.com/brunettoziosi" target="_blank"><i class='fa fa-facebook'></i></a>
        
      
        
        <a href="http://www.twitter.com/brunettoziosi" target="_blank"><i class='fa fa-twitter'></i></a>
        
      
        
        <a href="http://plus.google.com/&#43;BrunettoZiosi" target="_blank"><i class='fa fa-google-plus'></i></a>
        
      
        
        <a href="http://www.linkedin.com/in/brunettoziosi" target="_blank"><i class='fa fa-linkedin'></i></a>
        
      
        
        <a href="http://www.github.com/brunetto" target="_blank"><i class='fa fa-github'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
		    <div id="toc" class="pure-u-1 pure-u-md-1-4">
				<small class="toc-label">Contents</small>
		   	 	<nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#equations-of-motion:0e7dc98bf378aec2e704ff7a998df960">Equations of motion</a></li>
<li><a href="#time-stepping:0e7dc98bf378aec2e704ff7a998df960">Time stepping</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
		    </div>
		    
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/posts/cosmological-simulations-4-moving-the-particles/">Cosmological simulations: #4: Moving the particles!</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>13</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Nov</span> <span class="post-date-year">2011</span>
            	</span>
            	
            
            	
            		<span class="post-author-single">By <a class="post-author" href="http://brunettoziosi.eu" target="">Brunetto Ziosi</a></span>
            		




            	
            

			
			
				<div class="post-categories">
				
					<a class="post-category post-category-research" href="http://brunettoziosi.eu/categories/research">Research</a>
				
					<a class="post-category post-category-post" href="http://brunettoziosi.eu/categories/post">Post</a>
				
				</div>
			

			
		    	<div class="social-sharing">
	<a class="share-button-facebook" onClick="return popupShare(this.href);" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-4-moving-the-particles%2f" target="_blank"><i class="fa fa-facebook"><span>Like</span></i></a>
	<a class="share-button-google-plus" onClick="return popupShare(this.href);" href="https://plus.google.com/share?url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-4-moving-the-particles%2f" target="_blank"><i class="fa fa-google-plus"><span>Google +1</span></i></a>
	<a class="share-button-linkedin" onClick="return popupShare(this.href);" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-4-moving-the-particles%2f&title=Cosmological%20simulations%3a%20%234%3a%20Moving%20the%20particles%21&summary=%3ch3%20id%3d%22equations-of-motion%3a0e7dc98bf378aec2e704ff7a998df960%22%3eEquations%20of%20motion%3c%2fh3%3e%0a%0a%3cp%3eOnce%20we%20have%20learned%20how%20to%20calculate%20gravitational%20forces%20and%20decided%20which%20way%20is%20best%20for%20us%2c%20it%26rsquo%3bs%20time%20to%20move%20particles%20according%20to%20the%20force%20field.%3cbr%20%2f%3e%0aTo%20have%20an%20idea%20of%20what%20happens%20we%20can%20look%20at%20a%20simplified%20version%20of%20the%20pp-method%2c%20where%20the%20new%20coordinates%20and%20velocities%20are%20expressed%20starting%20from%20the%20previous%20values%3a%3c%2fp%3e%0a%0a%3cp%3e%24%5cmathbf%7bv%7d_i%5e%7bnew%7d%3d%5cmathbf%7bv%7d_i%5e%7bold%7d%2b%5cfrac%7b%5cmathbf%7bF%7d_i%7d%7bm_i%7d%5cDelta%20t%24%0a%24%5cmathbf%7bx%7d_i%5e%7bnew%7d%3d%5cmathbf%7bx%7d_i%5e%7bold%7d%2b%5cmathbf%7bv%7d_i%5cDelta%20t%24%3c%2fp%3e%0a%0a%3cp%3eMore%20in%20general%20we%20start%20from%20the%20Newtonian%20equation%20of%20motion%20for%20a%20set%20of%20particles%20interacting%20only%20through%20gravity%2c%20in%20particular%20we%20consider%20the%20Euler%20and%20Poisson%20equations.%20We%20express%20these%20in%20comoving%20coordinates%20because%20in%20this%20way%20we%20can%20focus%20on%20density%20and%20velocity%20perturbations%2c%20while%20the%20expansion%20of%20the%20universe%20is%20included%20in%20the%20scale%20factor%20%24a%24%20%28obtained%20from%20the%20Friedmann%20equations%29%3a%3c%2fp%3e%0a%0a%3cp%3e%24%5cfrac%7b%5cmathrm%7bd%7d%5e2%5cmathbf%7bx%7d%7d%7b%5cmathrm%7bd%7dt%5e2%7d%2b2%5cfrac%7b%5cmathrm%7bd%7da%2f%5cmathrm%7bd%7dt%7d%7ba%7d%5cfrac%7b%5cmathrm%7bd%7d%5cmathbf%7bx%7d%7d%7b%5cmathrm%7bd%7dt%7d%3d-%5cfrac%7b1%7d%7ba%5e2%7d%5cnabla_x%5cphi%24%3c%2fp%3e%0a%0a%3cp%3e%24%5cnabla_x%5e2%5cphi%3d4%5cpi%20Ga%5e2%5cbar%20%5crho%5cdelta%20%3d%20%5cfrac%7b3%7d%7b2%7dH_0%5e2%5cOmega_0%5cfrac%7b%5cdelta%7d%7ba%7d%24%3c%2fp%3e%0a}&source=Post%20It%21" target="_blank"><i class="fa fa-linkedin"><span>Share on LinkedIn</span></i></a>
	<a class="share-button-twitter" onClick="return popupShare(this.href);" href="http://twitter.com/share?text=Cosmological%20simulations%3a%20%234%3a%20Moving%20the%20particles%21&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-4-moving-the-particles%2f" target="_blank"><i class="fa fa-twitter"><span>Tweet</span></i></a>	
</div>
		    

			

            

<h3 id="equations-of-motion:0e7dc98bf378aec2e704ff7a998df960">Equations of motion</h3>

<p>Once we have learned how to calculate gravitational forces and decided which way is best for us, it&rsquo;s time to move particles according to the force field.<br />
To have an idea of what happens we can look at a simplified version of the pp-method, where the new coordinates and velocities are expressed starting from the previous values:</p>

<p>$\mathbf{v}_i^{new}=\mathbf{v}_i^{old}+\frac{\mathbf{F}_i}{m_i}\Delta t$
$\mathbf{x}_i^{new}=\mathbf{x}_i^{old}+\mathbf{v}_i\Delta t$</p>

<p>More in general we start from the Newtonian equation of motion for a set of particles interacting only through gravity, in particular we consider the Euler and Poisson equations. We express these in comoving coordinates because in this way we can focus on density and velocity perturbations, while the expansion of the universe is included in the scale factor $a$ (obtained from the Friedmann equations):</p>

<p>$\frac{\mathrm{d}^2\mathbf{x}}{\mathrm{d}t^2}+2\frac{\mathrm{d}a/\mathrm{d}t}{a}\frac{\mathrm{d}\mathbf{x}}{\mathrm{d}t}=-\frac{1}{a^2}\nabla_x\phi$</p>

<p>$\nabla_x^2\phi=4\pi Ga^2\bar \rho\delta = \frac{3}{2}H_0^2\Omega_0\frac{\delta}{a}$</p>

<p>Here $\mathbf{x}=\frac{\mathbf{r}}{a(t)}$ is the comoving coordinate of a particle, with $\mathbf{r}$ the physical coordinate; $\phi$ is the gravitational potential due to the density perturbations, $H_0$ the Hubble constant and $\Omega_0$ the density parameter at the present time. In real simulations these equations are modified changing variables to simplify the integration but the idea remain the same. They are valid for non-relativistic matter and on scales smaller than the Hubble radius $c/H_0$. The expansion of the universe act as a viscous force that opposes to the gravitational infall slowing down the growth of perturbations.<br />
Usually to integrate (read it as &ldquo;to solve&rdquo;!:P) the equations and obtain the new positions and velocities we use the Leap-Frog method because it minimizes the number of force evaluations. This is the most time consuming part of the code: Leap-Frog only requires one evaluation and the corresponding error is of the order of $\Delta t^3$. In this method positions and accelerations are computed at integer time steps and velocities at half time step: for example, positions are calculated at $t$ and velocities at $t+\Delta t/2$.</p>

<h3 id="time-stepping:0e7dc98bf378aec2e704ff7a998df960">Time stepping</h3>

<p>Choosing the simulation time step, that is the intervals between two calculation of positions and/or velocities, is crucial both for performances of the code and errors generation. Shorter time steps give smaller errors, but slow down the simulation.<br />
Time steps depend on the distribution of particles and may change during the evolution of the simulation. Use of individual time steps for each particle may speed up calculations, because we can tune the time step on for different particles, increasing the time resolution for particles in denser regions and decreasing it in low density regions. In this way larger $\Delta t$ are sufficient. When we decide the time step we have also to take care of the conservation of momentum and evolution of energy if it&rsquo;s not conserved (it can evolve according to the Irvine-Layzer equation).<br />
There are different possibility for how to calculate the time step, for example:</p>

<ul>
<li>we can take care of the validity of the Irvine-Layzer during the simulation; in this case we have to compute the force at mesh points and then interpolate it at particles positions but, because the force doesn&rsquo;t equal the gradient of the potential and the correction requires a direct sum on all the particles, this is not a good method</li>
<li>we can look at the convergence of velocities and final positions of particles using different time steps: reducing their duration we should approach the correct values</li>
<li>the reproducibility of initial conditions may be it&rsquo;s the most stringent criterion because it ensures that the results are correct: under certain conditions (linearity) running the particles forward and then back again we should get back the initial positions<br /></li>
</ul>

<p><em>References</em>:</p>

<ul>
<li><a href="http://www.ias.ac.in/currsci/apr102005/1088.pdf" target="_blank" title="J.S. Bagla, Cosmological N-body simulation: Techniques, scope and status">J. S. Bagla, Cosmological N-body simulation: Techniques, scope and status</a></li>
<li><a href="http://adsabs.harvard.edu/abs/1991ComPh...5..164B" target="_blank" title="J.S. Bagla and T. Padmanabham, Cosmological N-body simulations">J.S. Bagla and T. Padmanabham, Cosmological N-body simulations</a></li>
</ul>

	
			
		    	<div class="social-sharing">
	<a class="share-button-facebook" onClick="return popupShare(this.href);" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-4-moving-the-particles%2f" target="_blank"><i class="fa fa-facebook"><span>Like</span></i></a>
	<a class="share-button-google-plus" onClick="return popupShare(this.href);" href="https://plus.google.com/share?url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-4-moving-the-particles%2f" target="_blank"><i class="fa fa-google-plus"><span>Google +1</span></i></a>
	<a class="share-button-linkedin" onClick="return popupShare(this.href);" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-4-moving-the-particles%2f&title=Cosmological%20simulations%3a%20%234%3a%20Moving%20the%20particles%21&summary=%3ch3%20id%3d%22equations-of-motion%3a0e7dc98bf378aec2e704ff7a998df960%22%3eEquations%20of%20motion%3c%2fh3%3e%0a%0a%3cp%3eOnce%20we%20have%20learned%20how%20to%20calculate%20gravitational%20forces%20and%20decided%20which%20way%20is%20best%20for%20us%2c%20it%26rsquo%3bs%20time%20to%20move%20particles%20according%20to%20the%20force%20field.%3cbr%20%2f%3e%0aTo%20have%20an%20idea%20of%20what%20happens%20we%20can%20look%20at%20a%20simplified%20version%20of%20the%20pp-method%2c%20where%20the%20new%20coordinates%20and%20velocities%20are%20expressed%20starting%20from%20the%20previous%20values%3a%3c%2fp%3e%0a%0a%3cp%3e%24%5cmathbf%7bv%7d_i%5e%7bnew%7d%3d%5cmathbf%7bv%7d_i%5e%7bold%7d%2b%5cfrac%7b%5cmathbf%7bF%7d_i%7d%7bm_i%7d%5cDelta%20t%24%0a%24%5cmathbf%7bx%7d_i%5e%7bnew%7d%3d%5cmathbf%7bx%7d_i%5e%7bold%7d%2b%5cmathbf%7bv%7d_i%5cDelta%20t%24%3c%2fp%3e%0a%0a%3cp%3eMore%20in%20general%20we%20start%20from%20the%20Newtonian%20equation%20of%20motion%20for%20a%20set%20of%20particles%20interacting%20only%20through%20gravity%2c%20in%20particular%20we%20consider%20the%20Euler%20and%20Poisson%20equations.%20We%20express%20these%20in%20comoving%20coordinates%20because%20in%20this%20way%20we%20can%20focus%20on%20density%20and%20velocity%20perturbations%2c%20while%20the%20expansion%20of%20the%20universe%20is%20included%20in%20the%20scale%20factor%20%24a%24%20%28obtained%20from%20the%20Friedmann%20equations%29%3a%3c%2fp%3e%0a%0a%3cp%3e%24%5cfrac%7b%5cmathrm%7bd%7d%5e2%5cmathbf%7bx%7d%7d%7b%5cmathrm%7bd%7dt%5e2%7d%2b2%5cfrac%7b%5cmathrm%7bd%7da%2f%5cmathrm%7bd%7dt%7d%7ba%7d%5cfrac%7b%5cmathrm%7bd%7d%5cmathbf%7bx%7d%7d%7b%5cmathrm%7bd%7dt%7d%3d-%5cfrac%7b1%7d%7ba%5e2%7d%5cnabla_x%5cphi%24%3c%2fp%3e%0a%0a%3cp%3e%24%5cnabla_x%5e2%5cphi%3d4%5cpi%20Ga%5e2%5cbar%20%5crho%5cdelta%20%3d%20%5cfrac%7b3%7d%7b2%7dH_0%5e2%5cOmega_0%5cfrac%7b%5cdelta%7d%7ba%7d%24%3c%2fp%3e%0a}&source=Post%20It%21" target="_blank"><i class="fa fa-linkedin"><span>Share on LinkedIn</span></i></a>
	<a class="share-button-twitter" onClick="return popupShare(this.href);" href="http://twitter.com/share?text=Cosmological%20simulations%3a%20%234%3a%20Moving%20the%20particles%21&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-4-moving-the-particles%2f" target="_blank"><i class="fa fa-twitter"><span>Tweet</span></i></a>	
</div>
		    

			
				<div class="tags-list">
					<span class="dark-red">Tags</span><span class="decorative-marker">//</span>
					
	                <a class="post-tag post-tag-astro/physics" href="http://brunettoziosi.eu/tags/astro/physics">astro/physics</a>,
	                
	                <a class="post-tag post-tag-cosmic-structure" href="http://brunettoziosi.eu/tags/cosmic-structure">cosmic structure</a>,
	                
	                <a class="post-tag post-tag-cosmology" href="http://brunettoziosi.eu/tags/cosmology">Cosmology</a>,
	                
	                <a class="post-tag post-tag-phd" href="http://brunettoziosi.eu/tags/phd">PhD</a>,
	                
				</div>
			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="/posts/cosmological-simulations-3-force-calculation/">Cosmological simulations #3: force calculation!</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/posts/cosmological-simulations-7-limitations-and-some-considerations/">Cosmological simulations #7: Limitations and some considerations</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>
	<p>&copy; 2015 
	<a href="https://plus.google.com/117554238100031566866?rel=author">Brunetto Ziosi</a>. All rights reserved. </br>
	Theme by <a href="https://github.com/tmaiaroto/hugo-redlounge">Tom Maiaroto</a></p>
</div>
    </div>
  </div>
	

	
		<script type="text/javascript">
			function popupShare(url) {
				window.open(url, '_blank', 'scrollbars,resizable,height=525,width=600');
				return false;
			}
		</script>
	

  
  <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML&delayStartupUntil=configured" type="text/javascript"></script>
    <script type="text/javascript">
    
    MathJax.Hub.Config({
      tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js"]
      }
    });
    MathJax.Hub.Queue(function() {
      $(MathJax.Hub.getAllJax()).map(function(index, elem) {
        return(elem.SourceElement());
      }).parent().addClass('has-jax');
    });
    MathJax.Hub.Configured();
    </script>
</body>
</html>