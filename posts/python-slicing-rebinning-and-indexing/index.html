<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    Python slicing, rebinning and indexing // Post It!
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="Brunetto Ziosi">

  <meta property="og:title" content="Python slicing, rebinning and indexing" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://brunettoziosi.eu/posts/python-slicing-rebinning-and-indexing/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="http://brunettoziosi.eu/css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.svg">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Post It!" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

    <h1 class="brand-title">Post It!</h1>
    <h2 class="brand-tagline">Sticky digital notes
    </br>stuck on the Web!üòÉ</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="http://brunettoziosi.eu">Home</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/posts/">Blog</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/pages/curriculum-vitae/">CV</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/pages/">Pages</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="https://instagram.com/elbrunz/" target="_blank"><i class='fa fa-instagram'></i></a>
        
      
        
        <a href="http://www.facebook.com/brunettoziosi" target="_blank"><i class='fa fa-facebook'></i></a>
        
      
        
        <a href="http://www.twitter.com/brunettoziosi" target="_blank"><i class='fa fa-twitter'></i></a>
        
      
        
        <a href="http://plus.google.com/&#43;BrunettoZiosi" target="_blank"><i class='fa fa-google-plus'></i></a>
        
      
        
        <a href="http://www.linkedin.com/in/brunettoziosi" target="_blank"><i class='fa fa-linkedin'></i></a>
        
      
        
        <a href="http://www.github.com/brunetto" target="_blank"><i class='fa fa-github'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/posts/python-slicing-rebinning-and-indexing/">Python slicing, rebinning and indexing</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>25</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Nov</span> <span class="post-date-year">2011</span>
            	</span>
            	
            
            	
            		<span class="post-author-single">By <a class="post-author" href="http://brunettoziosi.eu" target="">Brunetto Ziosi</a></span>
            		




            	
            

			
			
				<div class="post-categories">
				
					<a class="post-category post-category-research" href="http://brunettoziosi.eu/categories/research">Research</a>
				
					<a class="post-category post-category-programming" href="http://brunettoziosi.eu/categories/programming">Programming</a>
				
					<a class="post-category post-category-python" href="http://brunettoziosi.eu/categories/python">Python</a>
				
					<a class="post-category post-category-post" href="http://brunettoziosi.eu/categories/post">Post</a>
				
				</div>
			

			
		    	<div class="social-sharing">
	<a class="share-button-facebook" onClick="return popupShare(this.href);" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fpython-slicing-rebinning-and-indexing%2f" target="_blank"><i class="fa fa-facebook"><span>Like</span></i></a>
	<a class="share-button-google-plus" onClick="return popupShare(this.href);" href="https://plus.google.com/share?url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fpython-slicing-rebinning-and-indexing%2f" target="_blank"><i class="fa fa-google-plus"><span>Google +1</span></i></a>
	<a class="share-button-linkedin" onClick="return popupShare(this.href);" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fpython-slicing-rebinning-and-indexing%2f&title=Python%20slicing%2c%20rebinning%20and%20indexing&summary=%3cp%3eDuring%20my%20master%20thesis%20I%20had%20to%20manage%20a%20lot%20of%20%28different%29%20data%20from%20GIF%20and%20GIF2%20projects%2c%20Millimillennium%2c%20Millenium%20and%20Millennium%202%20simulations%20and%20so%20on.%20Sometimes%20there%20were%20the%20need%20to%20sort%2c%20divide%20or%20rearrange%20these%20dataset.%3cbr%20%2f%3e%0aHere%20some%20examples.%3c%2fp%3e%0a}&source=Post%20It%21" target="_blank"><i class="fa fa-linkedin"><span>Share on LinkedIn</span></i></a>
	<a class="share-button-twitter" onClick="return popupShare(this.href);" href="http://twitter.com/share?text=Python%20slicing%2c%20rebinning%20and%20indexing&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fpython-slicing-rebinning-and-indexing%2f" target="_blank"><i class="fa fa-twitter"><span>Tweet</span></i></a>	
</div>
		    

			

            <p>During my master thesis I had to manage a lot of (different) data from GIF and GIF2 projects, Millimillennium, Millenium and Millennium 2 simulations and so on. Sometimes there were the need to sort, divide or rearrange these dataset.<br />
Here some examples.</p>

<p><strong>Sort the Millennium 2 data</strong></p>

<p>I developed this script to sort the Millennium 2 data in the $x$ coordinate. The dataset was composed of 512 hdf5 files and I would like to create 1000 files of 100 kpc/h each, taking particles for all the original files.</p>

<pre><code class="language-python">#!/bin/env python
import time
import numpy as np
import tables as tb
</code></pre>

<p>This is the usual modules importing. <code>tables</code> is the module provided by PyTables to manage, in a great way, hdf5 file under Python.</p>

<pre><code class="language-python">t_glob = time.time()
</code></pre>

<p>Timing is always good!!!</p>

<pre><code class="language-python"># This create the first &quot;5 Mpc/h&quot; file, every loop operate on 100 kpc/h of data 
for i in range(0,50):
    t = time.time()
    i_dist = i/10.0
    j_dist = i_dist + 0.1
    print &quot;Starting with limits [Mpc/h]&quot;, i_dist, j_dist
    temp2 = np.array([])
    temp2.shape = (0,3)
    # This loop open each of the 512 original files
    # selecting the particles inside the limits
    # and stacking them into the array that will 
    # be saved in the new file
    for j in range(0,512):
        filename = '../../hdf5/data_'+str(j)
        print &quot;Open &quot;, filename
        h5 = tb.openFile(filename, 'r')
        original = h5.root.data.read()
        h5.close()
        temp = original[original[:,0]&amp;gt;i_dist]
        if temp.size &amp;lt; 3:
            temp3 = np.array([])
            temp3.shape=(0,3)
        else:
            temp3 = temp[temp[:,0]&amp;lt;=j_dist]
        try:
            temp2 = np.vstack((temp2,temp3))
        except:
            print &quot;Error in stacking&quot;
            print &quot;temp2 dimensions &quot;, temp2.shape
            print &quot;temp3 dimensions &quot;, temp3.shape
            exit()
    tt=time.time()

    # Sorting the array in the x direction
    temp2[temp2[:,0].argsort(),]
    print &quot;Time for argsort &quot;, time.time()-tt

    # Writing data to file
    destname = '../../hdf5_sorted/mill2sort-'+str(i)
    print &quot;Writing &quot;, destname
    dest = tb.openFile(destname, 'w')
    dest.createArray(dest.root, 'data', temp2, title='data')
    dest.flush()
    dest.close()
    print &quot;Time for loop  &quot;, i, &quot; is &quot;, time.time()-t
print &quot;Done in &quot;,time.time()-t_glob, &quot;seconds&quot;
</code></pre>

<p><strong>Rebin the sorted Millennium 2 data</strong></p>

<p>After I have sorted the data, we need to rebin the dataset because it doesn&rsquo;t fit into our machine memory.<br />
This script make use of the <a href="http://brunettoziosi.blogspot.it/2011/11/python-parallel-job-manager.html" target="_blank" title="Python parallel job¬†manager"> parallel job manager</a> to break the 1000 files of the sorted dataset into 5000 files each containing 20 kpc/h of data, sorted in the $x$ direction.</p>

<pre><code class="language-python">#! /usr/bin/env python

import sys, os
import numpy as np
import tables as tb
from subprocess import Popen, PIPE
from multiprocessing import Process, Queue


#############################################
sub_slice_dim = 0.02    #Mpc/h
sub_slice_num = 5 # for each of the original slice
n_procs = 5
tot_mill_slice = 999   # number of original slices
############################################


def slicing(i, j, sub_slice_dim, sub_slice_num):
    &quot;&quot;&quot;Given a mill2 slice it creates 5 subslices.
    &quot;&quot;&quot;
    start_dim = j\*sub_slice_dim
    stop_dim = start_dim + sub_slice_dim
    print &quot;Loop &quot;, j, &quot; of &quot;, sub_slice_num , &quot; between &quot;, start_dim, &quot; and &quot;, stop_dim, &quot; in slice &quot;, i 
    pos_greater = mill_slice[start_dim &amp;lt; mill_slice[:,0]]
    pos = pos_greater[pos_greater[:,0] &amp;lt;= stop_dim]
    h5=tb.openFile('/home/ziosi/mill2_data/hdf5_sorted_rebinned/mill2sort-'+str(i*5+j)+'.h5', 'w')
    h5.createArray(h5.root, 'data', pos, title='mill2_sorted_rebinned_pos')
    h5.flush()
    h5.close()

def breakmill(in_queue):
    &quot;&quot;&quot;Bring a slice from the queue and start the function to
    sub_slice it.
    &quot;&quot;&quot;
    while in_queue.qsize != 0:
        ii = in_queue.get()
        i = ii[0]
        sub_slice_dim = ii[1]
        sub_slice_num = ii[2]
        original_slice = &quot;/home/ziosi/mill2_data/hdf5_sorted/mill2sort-&quot;+str(i)
        mill_slice = tb.openFile(original_slice, 'r')
        slice_data = mill_slice.root.data.read()
        slice_min = np.amin(slice_data[:,0])
        for j in xrange(5):
            slicing(i, j, sub_slice, slice_dim, sub_slice_num)
    
# Create the queues.
in_queue = Queue()
out_queue = Queue()

# Fill the input queue.
try:
    for i in xrange(tot_mill_slice):
        in_queue.put([i, sub_slice_dim, sub_slice_num])
except:
    print &quot;Input queue not filled, exit!&quot;
    sys.exit(1)

procs = []

# Create the processes.
try:
    for i in range(n_procs):
        print &quot;Process creation loop &quot;, i
        procs.append(Process(target=breakmill, args=(in_queue, out_queue)))
except:
    print &quot;Creating processes not complete, exit...&quot;
    sys.exit(1)

# Start the processes.
try:
    for i in procs:
        i.start()
except:
    print &quot;Start processes not complete, exit...&quot;;
    sys.exit(1)

# Check for processes status.
for i in procs:
    print &quot;Process &quot;, i,&quot; @ &quot; , i.pid, &quot; is &quot;, status(i)

print &quot;Done.&quot;
</code></pre>

<p><strong>Indexing data</strong></p>

<p>We also need to index a data file to can retrieve only a slice from the entire file. We did it using the following three elements:</p>

<pre><code class="language-python">flags = np.arange(0, 110, 0.1)
</code></pre>

<p>is the array containing the markers for the distances we want to index. This means that if we want to index distances from 0 to 10 every 1, we get: 0,1,2,3,4,5,6,7,8,9,10, so we can select, for example, the element between 0 and 1 without load the entire list.</p>

<pre><code class="language-python">start = indexes[np.maximum(np.searchsorted(indexes[:,0], xstart, side='left')-1, 0), 1]
</code></pre>

<p>contains the index of the cell in the array that contains the first element we want</p>

<pre><code class="language-python">stop = indexes[np.minimum(np.searchsorted(indexes[:+1], xstop, side='right')+1, indexes.shape[0]-1), 2]
</code></pre>

<p>contains the index of the cell in the array that contains the first element we want.</p>

<pre><code class="language-python">indexes = np.hstack((flags.reshape((flags.shape[0], 1)), start.reshape((start.shape[0], 1)), end.reshape((end.shape[0], 1))))
</code></pre>

<p>is the $(n,3)$ array with the flag, the start and the stop indexes. It is saved into the data file.</p>

	
			
		    	<div class="social-sharing">
	<a class="share-button-facebook" onClick="return popupShare(this.href);" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fpython-slicing-rebinning-and-indexing%2f" target="_blank"><i class="fa fa-facebook"><span>Like</span></i></a>
	<a class="share-button-google-plus" onClick="return popupShare(this.href);" href="https://plus.google.com/share?url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fpython-slicing-rebinning-and-indexing%2f" target="_blank"><i class="fa fa-google-plus"><span>Google +1</span></i></a>
	<a class="share-button-linkedin" onClick="return popupShare(this.href);" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fpython-slicing-rebinning-and-indexing%2f&title=Python%20slicing%2c%20rebinning%20and%20indexing&summary=%3cp%3eDuring%20my%20master%20thesis%20I%20had%20to%20manage%20a%20lot%20of%20%28different%29%20data%20from%20GIF%20and%20GIF2%20projects%2c%20Millimillennium%2c%20Millenium%20and%20Millennium%202%20simulations%20and%20so%20on.%20Sometimes%20there%20were%20the%20need%20to%20sort%2c%20divide%20or%20rearrange%20these%20dataset.%3cbr%20%2f%3e%0aHere%20some%20examples.%3c%2fp%3e%0a}&source=Post%20It%21" target="_blank"><i class="fa fa-linkedin"><span>Share on LinkedIn</span></i></a>
	<a class="share-button-twitter" onClick="return popupShare(this.href);" href="http://twitter.com/share?text=Python%20slicing%2c%20rebinning%20and%20indexing&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fpython-slicing-rebinning-and-indexing%2f" target="_blank"><i class="fa fa-twitter"><span>Tweet</span></i></a>	
</div>
		    

			
				<div class="tags-list">
					<span class="dark-red">Tags</span><span class="decorative-marker">//</span>
					
	                <a class="post-tag post-tag-research" href="http://brunettoziosi.eu/tags/research">research</a>,
	                
	                <a class="post-tag post-tag-python" href="http://brunettoziosi.eu/tags/python">python</a>,
	                
	                <a class="post-tag post-tag-programming" href="http://brunettoziosi.eu/tags/programming">programming</a>,
	                
	                <a class="post-tag post-tag-phd" href="http://brunettoziosi.eu/tags/phd">PhD</a>,
	                
				</div>
			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="/posts/cosmological-simulations-6-adding-gas/">Cosmological simulations #6: adding gas!</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/posts/python-cli-and-configuration-file-parser/">Python CLI and configuration file parser</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>
	<p>&copy; 2015 
	<a href="https://plus.google.com/117554238100031566866?rel=author">Brunetto Ziosi</a>. All rights reserved. </br>
	Theme by <a href="https://github.com/tmaiaroto/hugo-redlounge">Tom Maiaroto</a>, Generated (with ‚ù§) using <a href="http://gohugo.io/">Hugo.</a></p>
</div>

    </div>
  </div>
	

	
		<script type="text/javascript">
			function popupShare(url) {
				window.open(url, '_blank', 'scrollbars,resizable,height=525,width=600');
				return false;
			}
		</script>
	

  
  <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML&delayStartupUntil=configured" type="text/javascript"></script>
    <script type="text/javascript">
    
    MathJax.Hub.Config({
      tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js"]
      }
    });
    MathJax.Hub.Queue(function() {
      $(MathJax.Hub.getAllJax()).map(function(index, elem) {
        return(elem.SourceElement());
      }).parent().addClass('has-jax');
    });
    MathJax.Hub.Configured();
    </script>
</body>
</html>