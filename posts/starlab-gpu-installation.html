<!DOCTYPE html><html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta charset="utf-8">
    <meta name="author" content="brunetto">
    <title>StarLab-GPU installation | for future reference...</title>
    
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
   tex2jax: {
       inlineMath: [ ['$','$'], ["\\(","\\)"] ],
       displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
   },
   displayAlign: 'left', // Change this to 'center' to center equations.
   "HTML-CSS": {
       styles: {'.MathJax_Display': {"margin": 0}}
   }
});
</script>

            <link href="../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
            <link href="../assets/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css">
        <link href="../assets/css/rst.css" rel="stylesheet" type="text/css">
        <link href="../assets/css/code.css" rel="stylesheet" type="text/css">
        <link href="../assets/css/colorbox.css" rel="stylesheet" type="text/css">
        <link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
      <link rel="canonical" href="posts/starlab-gpu-installation.html">
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->
            <link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">

    





    <link href="https://plus.google.com/117796240971605586205" rel="publisher">
</head>
<body>
<!-- Menubar -->
<div class="navbar navbar-fixed-top" id="navbar">
    <div class="navbar-inner">
        <div class="container">

        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </a>

            <a class="brand" href="brunettoziosi.eu">
            for future reference...
            </a>
            <!-- Everything you want hidden at 940px or less, place within here -->
            <div class="nav-collapse collapse">
                <ul class="nav">
                    
                <li><a href="../stories/about.html">About</a>
                </li><li><a href="../index.html">Blog</a>
                </li><li><a href="../stories/index.html">SiteIndex</a>
                </li><li><a href="../archive.html">Archives</a>
                </li><li><a href="../categories/index.html">Tags</a>
                </li><li><a href="../rss.xml">RSS</a>

                </li></ul>
                    
<!-- Custom search with google-->
<form id="search" action="http://google.com/search" method="get" class="navbar-form pull-left">
<input type="hidden" name="q" value="site:brunettoziosi.eu">
<input type="text" name="q" maxlength="255" results="0" placeholder="Search">
</form>
<!-- End of custom search -->

                <ul class="nav pull-right">
                
                
                </ul>
            </div>
        </div>
    </div>
</div>
<!-- End of Menubar -->
<div class="container-fluid" id="container-fluid">
    <!--Body content-->
    <div class="row-fluid">
    <div class="span2"></div>
    <div class="span8">
    
    <article class="postbox post-text">
    <div class="h-entry" itemscope="itemscope" itemtype="http://schema.org/Article">
    
    <h1 class="p-name" itemprop="headline name">StarLab-GPU installation</h1>

    <hr>
    <small>
        Posted: <time class="published dt-published" datetime="2013-08-20T09:34:11+00:00" itemprop="datePublished">2013-08-20 09:34</time>
        

		
          |  
        More posts about 
    <span itemprop="keywords">
        <a class="tag p-category" href="../categories/gpu.html"><span class="badge badge-info">GPU</span></a>
        <a class="tag p-category" href="../categories/simulations.html"><span class="badge badge-info">simulations</span></a>
        <a class="tag p-category" href="../categories/n-body.html"><span class="badge badge-info">N-body</span></a>
    </span>


          |  
		
    </small>
    <hr>
    <div class="e-content" itemprop="articleBody text">
    <div><ul>
<li><a href="../stories/research/utils/starlab-gpu-old-guide.html">Click here for the old guide!!!</a>    </li>
<li>2014/09/16: updated with installation instruction for g2@Swinburne and some troubleshooting.</li>
</ul>
<hr>
<p><strong>UPDATE:</strong> if you want to compile starlab <strong>without GPU support</strong>, you only need to     </p>
<ul>
<li>ignore the "<code>sapporo</code>"  and "<code>CUDA</code>" instructions</li>
<li>rename <code>starlab/local/grape.sh</code> to <code>starlab/local/_grape.sh</code> </li>
<li>substitute <code>configure --without-f77</code> with <code>configure --with-grape=no --without-f77</code>)</li>
<li>in case you can't <code>make</code> succesfully may be you need to copy the folder 
<code>starlab/src/gfx</code> and do not make clean</li>
</ul>
<hr>
<p>Well, probably you landed here searching information about StarLab, how to 
install it, how to run it, how prevent it to harm your cat.</p>
<p><strong>DISCLAIMER 1:</strong> I won't promise anything about your cat but I will try to help you having a 
reasonable well running installation of StarLab.</p>
<p><strong>DISCLAIMER 2:</strong> I'm not a programmer, I'm not a system administrator and I don't even 
know how to program in CUDA (yet). Maybe something here is wrong ore outdated. 
I'm only giving you some of the experienced I collected in n+1 times I installed StarLab. 
Nothin less, nothing more.  <br>
Also note that most of the knowledge I put here come 
from my <a href="http://web.pd.astro.it/mapelli/">supervisor</a>.  <br>
I also thanks Mario Spera for the usefull advices.</p>
<p><strong>DISCLAIMER 3:</strong> StarLab still seems to <strong>always</strong> crash if you try to simulate a system 
with more than ~6000 binaries.</p>
<h3>StarLab</h3>
<p><a href="http://www.sns.ias.edu/~starlab/">StarLab</a> is "A Software Environment for Collisional Stellar Dynamics".
<a href="http://www.sns.ias.edu/~starlab/">Here</a> you can find useful information about it that 
is not useful to rewrite here, so have a look and then come back!:)</p>
<!-- TEASER_END -->

<h3>StarLab-GPU</h3>
<p>Welcome back!!  <br>
Next step: StarLab was designed to run on <a href="http://en.wikipedia.org/wiki/Gravity_Pipe">GRAPE</a> 
but thanks to the <a href="http://castle.strw.leidenuniv.nl/software/sapporo.html">Sapporo</a> 
library you can run it on GPUs.    </p>
<p>Now we will try to install a GPU-ready version of StarLab. To be honest, we run 
a <strong>private</strong> version of StarLab for GPU with some customizations (if you are interested, 
see <a href="http://arxiv.org/abs/1211.6441">Mapelli et al. 2013</a>; <a href="http://arxiv.org/abs/1301.4227">Mapelli &amp; Bressan 2013</a>).  <br>
Unfortunately you can't download it now, but I hope the differences in the installation 
process are negligible. Ask us if you are interested in our version of StarLab.  <br>
Because I'm not sure about what you will find in the public version os Sapporo and StarLab, 
I will show my version of the relevant files you need to install everything. 
The installation is done on a Ubuntu 14.04 workstation so change them accordingly to 
your OS. I will also provide some examples on what you need to install StarLab on 
the clusters I tested.    </p>
<p>Let's start!!</p>
<h5>Download</h5>
<p>Be sure you have boost libraries, nVidia driver and CUDA correctly installed. 
You can try to check them using </p>
<ul>
<li><code>locate cuda | grep nvcc</code> (cuda compiler)</li>
<li><code>locate cuda | grep include</code></li>
<li><code>locate cuda | grep include | grep toolkit</code> (for the SDK files of the new release)</li>
<li><code>locate cuda | grep lib | grep cudart</code> (CUDA runtime)</li>
<li><code>locate cuda | boost lib</code></li>
<li><code>locate cuda | boost include</code></li>
</ul>
<p>It could be also useful to have a copy of the old CUDA SDK. Yes, I know, it's a mess, 
but it's not my fault!:P</p>
<p>Download </p>
<ul>
<li><a href="http://www.sns.ias.edu/~starlab/download/starlab.tar.gz">StarLab</a></li>
<li><a href="http://castle.strw.leidenuniv.nl/documents/Sapporo/sapporo161.tgz">Sapporo</a></li>
</ul>
<p>and decompress the archives with <code>tar -xvf archiveName</code>.  <br>
Try to have the following folder tree:    </p>
<ul>
<li><code>$SLPATH/slpack</code></li>
<li><code>$SLPATH/slpack/NVIDIA</code></li>
<li><code>$SLPATH/slpack/NVIDIA/NVIDIA_CUDA-5.0_Samples</code></li>
<li><code>$SLPATH/slpack/NVIDIA/NVIDIA_GPU_Computing_SDK</code></li>
<li><code>$SLPATH/slpack/sapporo</code></li>
<li><code>$SLPATH/slpack/starlab</code></li>
</ul>
<p>The NVIDIA folder is optional, but I would suggest to have with you alle the NVIDIA 
file you can find, soon or later you will need them. CUDA is continuosly changing, 
SDK is not toolkit, dependencies are different and broken between different versions.
We will try to survive and to have the most standard installation we can.    </p>
<p><code>$SLPATH</code> should be the path where you put your StarLab installation.   <br>
I'm not sure about what you will find in the public version of StarLab and Sapporo.</p>
<h4>Sapporo</h4>
<p>Enter in the sapporo folder, and to be sure to start a clean installation run 
<code>make clean</code>. 
Here you need to find:</p>
<ul>
<li><code>Makefile</code></li>
<li><code>compile.sh</code></li>
<li><code>host_evaluate_gravity.cu</code></li>
</ul>
<p><code>compile.sh</code> is the script StarLab will run later to decide if you are worthy of 
its presence in your computer. If <code>compile.sh</code> fail, StarLab won't install.    </p>
<p>You also need to find somewhere (= in an old CUDA SKD?) </p>
<ul>
<li><code>cutil.h</code></li>
<li><code>multithreading.h</code></li>
</ul>
<p>and to copy them in this folder.  <br>
If you are not able to find them, ask me, I have copies of those files.    </p>
<p>Open <code>host_evaluate_gravity.cu</code> and change </p>
<div class="code"><pre><span class="c">#include &lt;cutil.h&gt;</span>
<span class="c">#include &lt;multithreading.h&gt;</span>
</pre></div>


<p>to </p>
<div class="code"><pre><span class="c">#include "cutil.h"</span>
<span class="c">#include "multithreading.h"</span>
</pre></div>


<p>This is to make Sapporo read the local version of <code>cutil.h</code> and <code>multithreading.h</code> 
in case your CUDA version does not support them anymore.     </p>
<p>It's time to fix a bug (thanks Mario):
in <code>sapporo.cpp</code> change    </p>
<div class="code"><pre>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">nCUDAdevices</span> <span class="o">=</span> <span class="n">how_many</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">" sapporo::open - no config file is found </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"  using all %d CUDA device(s), nj_max= %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">nCUDAdevices</span><span class="p">,</span> <span class="n">nj_max</span><span class="p">);</span>
        <span class="c1">//Set original_how_many to a positive number so we get assigned different devices</span>
        <span class="c1">//incase the devices are not in compute exclusive mode.</span>
        <span class="n">original_how_many</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>


<p>to    </p>
<div class="code"><pre>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">nCUDAdevices</span> <span class="o">=</span> <span class="n">how_many</span><span class="p">;</span>
        <span class="n">fclose</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span> <span class="c1">// thanks Mario Spera, without this SL will crash after a while if using sapporo.config</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">" sapporo::open - no config file is found </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"  using all %d CUDA device(s), nj_max= %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">nCUDAdevices</span><span class="p">,</span> <span class="n">nj_max</span><span class="p">);</span>
    <span class="c1">//Set original_how_many to a positive number so we get assigned different devices</span>
    <span class="c1">//incase the devices are not in compute exclusive mode.</span>
    <span class="n">original_how_many</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>


<p>so the <code>sapporo.config</code> file can be close and won't crash your run.    </p>
<p>Now open <code>Makefile</code> and fit </p>
<div class="code"><pre><span class="n">CXX</span>  <span class="o">:=</span> <span class="n">g</span><span class="o">++</span>
<span class="n">CC</span>   <span class="o">:=</span> <span class="n">gcc</span>
<span class="n">NVCC</span> <span class="o">:=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">nvcc</span>
<span class="n">CUDAPATH</span>    <span class="o">:=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span>
<span class="n">CUDAINCLUDE</span> <span class="o">:=</span> <span class="o">-</span><span class="n">I</span><span class="err">$</span><span class="p">(</span><span class="n">CUDAPATH</span><span class="p">)</span> 
<span class="n">BOOSTPATH</span> <span class="o">:=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">boost</span> 
<span class="n">BOOSTINCLUDE</span> <span class="o">:=</span> <span class="o">-</span><span class="n">I</span><span class="err">$</span><span class="p">(</span><span class="n">BOOSTPATH</span><span class="p">)</span>
</pre></div>


<p>to your case.  <br>
Open <code>compile.sh</code> and be sure to have something like this:</p>
<div class="code"><pre><span class="c">#!/bin/sh</span>

<span class="nv">flags</span><span class="o">=</span>-DNGB

<span class="nv">CUDAINC</span><span class="o">=</span><span class="s2">"-I/usr/include -I/usr/lib/nvidia-cuda-toolkit/include/"</span>
<span class="nv">CUDALIB</span><span class="o">=</span><span class="s2">"-L/usr/lib/x86_64-linux-gnu/"</span>
<span class="nv">CUDAFLAG</span><span class="o">=</span><span class="s2">"-lcudart"</span>
<span class="nv">BOOSTINC</span><span class="o">=</span><span class="s2">"-I/usr/include/boost"</span>
<span class="nv">BOOSTLIB</span><span class="o">=</span><span class="s2">"-L/usr/lib/x86_64-linux-gnu/"</span>
<span class="nv">BOOSTFLAG</span><span class="o">=</span><span class="s2">"-lboost_system -lboost_thread -lpthread"</span>


g++ -O3 <span class="nv">$flags</span> -g -o test_gravity_block test_gravity_block.cpp -L. -lsapporo <span class="nv">$CUDAINC</span> <span class="nv">$CUDALIB</span> <span class="nv">$CUDAFLAG</span> <span class="nv">$BOOSTINC</span> <span class="nv">$BOOSTLIB</span> <span class="nv">$BOOSTFLAG</span>
g++ -O3 <span class="nv">$flags</span> -g -o test_gravity_N2ngb test_gravity_N2ngb.cpp -L. -lsapporo <span class="nv">$CUDAINC</span> <span class="nv">$CUDALIB</span> <span class="nv">$CUDAFLAG</span> <span class="nv">$BOOSTINC</span> <span class="nv">$BOOSTLIB</span> <span class="nv">$BOOSTFLAG</span>
</pre></div>


<p>Try to compile with <code>make</code>. If it works, try to tun <code>bash compile.sh</code>. If this works too, 
then test sapporo with </p>
<ul>
<li><code>./test_gravity_block 800</code></li>
<li><code>./test_gravity_block 800</code></li>
</ul>
<p>Be aware that a number (of particles) too small would crash the tests.</p>
<p>Assuming <code>sapporo</code> is ready, let's move to starlab.</p>
<h4>StarLab</h4>
<p>In StarLab the relevant files you have to worry about are </p>
<ul>
<li><code>sbin/sqrt.c</code></li>
<li><code>configure</code></li>
<li><code>local/grape.sh</code></li>
</ul>
<p>Rename <code>sbin/sqrt.c</code> to <code>sbin/sqrt.C</code> otherwise 
you could have linker problems again the C math library.  <br>
Now open <code>configure</code> and search for CUDA. Probably you won't find anything.   <br>
Search for <code>Check all named libraries for g6_open</code>, you should find something like </p>
<div class="code"><pre><span class="c">#   Check all named libraries for g6_open() (GRAPE-6).</span>

    <span class="nv">grape6</span><span class="o">=</span>no

    <span class="k">for </span>gl in <span class="nv">$GRAPE_LIBS_</span>; <span class="k">do</span>
<span class="k">        </span><span class="nv">as_ac_Lib</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">"ac_cv_lib_${gl/-l/}''_g6_open_"</span> | <span class="nv">$as_tr_sh</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"$as_me:$LINENO: checking for g6_open_ in -l${gl/-l/}"</span> &gt;&amp;5
</pre></div>


<p>modify it to include boost and CUDA like:</p>
<div class="code"><pre><span class="k">for </span>gl in <span class="nv">$GRAPE_LIBS_</span>; <span class="k">do</span>
<span class="k">    </span><span class="nv">CUDAINC</span><span class="o">=</span><span class="s2">"-I/usr/include -I/usr/lib/nvidia-cuda-toolkit/include/"</span>
    <span class="nv">CUDALIB</span><span class="o">=</span><span class="s2">"-L/usr/lib/x86_64-linux-gnu/"</span>
    <span class="nv">CUDAFLAG</span><span class="o">=</span><span class="s2">"-lcudart"</span>
    <span class="nv">BOOSTINC</span><span class="o">=</span><span class="s2">"-I/usr/include/boost/"</span>
    <span class="nv">BOOSTLIB</span><span class="o">=</span><span class="s2">"-L/usr/lib/x86_64-linux-gnu/"</span>
    <span class="nv">BOOSTFLAG</span><span class="o">=</span><span class="s2">"-lboost_system -lboost_thread -lpthread"</span>

    <span class="nv">LIBS</span><span class="o">=</span><span class="s2">"$CUDAINC $CUDALIB $CUDAFLAG $BOOSTINC $BOOSTLIB $BOOSTFLAG -DNGB"</span>

    <span class="nv">as_ac_Lib</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">"ac_cv_lib_${gl/-l/}''_g6_open_"</span> | <span class="nv">$as_tr_sh</span><span class="sb">`</span>
</pre></div>


<p>Be sure to always use double quotes and to terminate the paths to folders with a slash (<code>/</code>), 
some machines are quite choosy.</p>
<p>Last edit is on <code>local/grape.sh</code> to let StarLab know where your sapporo installation is:</p>
<div class="code"><pre><span class="nv">GRAPE_LDFLAGS_</span><span class="o">=</span><span class="s1">'-L$SLPATH/slpack/sapporo'</span>
<span class="nv">GRAPE_LIBS_</span><span class="o">=</span><span class="s1">'-lsapporo'</span>
<span class="c"># For now, define this as `yes' for the AMD64 boxes only, `no' otherwise.</span>
<span class="nv">OLD_READ_NEIGHBOUR_LIST</span><span class="o">=</span>no
</pre></div>


<p>Before compiling, if you want, you can check also <code>sapporo/sapporo.config</code>.  <br>
Inside you will find something like that:</p>
<div class="code"><pre>524288
-1
0
1
</pre></div>


<p>where 524288 should be the maximum number of particles you can handle, -1 the number 
of CUDA devices to use (-1 means all? maybe...), 0 and 1 are the GPU number you want to use.   <br>
Recent CUDA seems to be smart enought to understand where to run without having to specify 
(but look after your cat!!!).    </p>
<p>Alright!! If you managed to reach this point, very good. Last three commands. In the 
<code>starlab</code> folder run </p>
<ul>
<li><code>configure --with-f77=no</code></li>
<li><code>make</code></li>
</ul>
<p>go out for a walk</p>
<ul>
<li><code>make install</code></li>
</ul>
<p>When running configure, avoid the <code>--without-option</code> version of an option, prefer 
<code>--with-option=no</code>, it's safer.</p>
<p>If you recompile StarLab AND/OR Sapporo, type <code>make clean</code> two times. delete the files in 
<code>starlab/usr/bin</code>, turn around 3 times, touch your nose and type <code>make</code> two times. Then 
<code>make install</code> again.   <br>
No, <code>make clean</code> and <code>make</code> are not enought to update your object 
files or binaries.    </p>
<p>Depending on your environment, if you run into problems, be sure that:</p>
<ul>
<li>you loaded the correct modules (if you are in a cluster for examples</li>
<li>you are into the right node (some machine let you compile your code on a 
node that is not the login node)</li>
<li>if you encounter strange messages regarding missing rules for missing files, 
for example <code>libxhdyn.la</code> or something regarding <code>gfx</code>-something, may be tou need to 
tune your config file to exclude, for example, the X/Qt/... libraries, in case 
try to run <code>configure --with-f77=no --with-qt=no</code>; in case try to have a look at 
<code>configure --help</code></li>
</ul>
<h4>Run StarLab</h4>
<p>Before run a simulation you need to create the initial conditions.</p>
<h5>Initial Conditions</h5>
<p>StarLab is provided with few tools to help (really?) you in this task. A common 
way to create ICs for <a href="http://arxiv.org/abs/1404.7147">our simulations</a> is something like:     </p>
<p><code>&lt;ehm, I don't know if I can tell you, sorry man...:(&gt;</code></p>
<h5>Launch</h5>
<p>StarLab read ICs from the STDIN, write the output snapshots to STDOUT and everything 
you want to know about your simulations to STDERR, so, <code>&lt;ehm.... see ICs&gt;</code></p>
<h5>Tidal fields</h5>
<p>Be patience...</p>
<h4>Known issues and Troubleshooting</h4>
<p>If StarLab did not kill your cat in a horrile way, then, it can still ruin your life.  <br>
Some of the things that can happen are:</p>
<ul>
<li>you can find binaries with eccentricity greater than one (StarLab does 
not update some binaries after they are disrupted? flybyes seen as binaries? don't know)</li>
<li>StarLab can crash if you try to simulate a number of centers of mass greater than 
5*10^4 together with a fraction of primordial binaries &gt;=0.1</li>
<li>boost problems? check the correct flags for your version (choose among some combination of 
<code>-lboost_system, -lboost_system-mt, -lboost_thread, -lpthread</code>)</li>
<li>check you put all the <code>_</code>, "-I", "-l", "-L" in the right places</li>
<li>check all the libraries paths</li>
<li>check for double quotes (<code>"</code>) instead of single ones (<code>'</code>) in the paths</li>
<li>check the modules, environment variables</li>
<li>check you are on the right node</li>
<li>check your environment against the configure options you passed 
(have a look at <code>configure --help</code>)</li>
<li>if you need to modify StarLab and you want to add your own flags, 
you need to comment </li>
</ul>
<div class="code"><pre>  <span class="n">getia</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">get_log_story</span><span class="p">(),</span> <span class="s">"step_slow"</span><span class="p">,</span>
        <span class="n">b</span><span class="o">-&gt;</span><span class="n">get_kira_counters</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">step_slow</span><span class="p">,</span> <span class="n">nss</span><span class="p">);</span>
</pre></div>


<p>function call in <code>kira_counters.C</code> otherwise you won't be able to compile StarLab.    </p>
<h4>Clusters</h4>
<h5>EURORA</h5>
<ul>
<li>in <code>setup_sapporo.sh</code>
(if you want to compile sapporo using queues, or, load modules by hand if you want to 
compile interactively)</li>
</ul>
<div class="code"><pre>module purge
module load profile/advanced
module load gnu/4.6.3
module load boost/1.53.0--gnu--4.6.3
module load cuda

<span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/cineca/prod/compilers/cuda/5.0.35/none/lib64:/cineca/prod/libraries/boost/1.53.0/gnu--4.6.3/lib
<span class="nb">export </span>LD_LIBRARY_PATH
<span class="nb">cd</span> <span class="nv">$HOME</span>/slPack/sapporo
</pre></div>


<ul>
<li>in <code>compile.sh</code></li>
</ul>
<div class="code"><pre><span class="nv">CUDAINC</span><span class="o">=</span><span class="s2">"-I/cineca/prod/compilers/cuda/5.0.35/none/include/ -I/cineca/prod/compilers/cuda/5.0.35/none/samples/common/inc/ -I/cineca/prod/libraries/boost/1.53.0/gnu--4.6.3/include/"</span>
<span class="nv">CUDALIB</span><span class="o">=</span><span class="s2">"-L/cineca/prod/compilers/cuda/5.0.35/none/lib64 -L/cineca/prod/libraries/boost/1.53.0/gnu--4.6.3/lib -lcudart"</span>
g++ -O3 <span class="nv">$flags</span> -g -o test_gravity_block test_gravity_block.cpp -L. -lsapporo <span class="nv">$CUDAINC</span> <span class="nv">$CUDALIB</span> -lboost_thread-mt
g++ -O3 <span class="nv">$flags</span> -g -o test_gravity_N2ngb test_gravity_N2ngb.cpp -L. -lsapporo <span class="nv">$CUDAINC</span> <span class="nv">$CUDALIB</span> -lboost_thread-mt
</pre></div>


<ul>
<li>in <code>Makefile</code></li>
</ul>
<div class="code"><pre>NVCC :<span class="o">=</span> /cineca/prod/compilers/cuda/5.0.35/none/bin/nvcc
CUDAPATH    :<span class="o">=</span> /cineca/prod/compilers/cuda/5.0.35/none
CUDASDKPATH :<span class="o">=</span> /cineca/prod/compilers/cuda/5.0.35/none/samples
CUDAINCLUDE :<span class="o">=</span> -I<span class="k">$(</span>CUDAPATH<span class="k">)</span>/include -I<span class="k">$(</span>CUDASDKPATH<span class="k">)</span>/common/inc 
BOOSTPATH :<span class="o">=</span> /cineca/prod/libraries/boost/1.53.0/gnu--4.6.3/include
</pre></div>


<ul>
<li>in <code>configure</code></li>
</ul>
<div class="code"><pre><span class="nv">CUDAINC</span><span class="o">=</span><span class="s2">"-I/cineca/prod/compilers/cuda/5.0.35/none/include -I/cineca/prod/compilers/cuda/5.0.35/none/samples/common/inc -I/cineca/prod/libraries/boost/1.53.0/gnu--4.6.3/include/"</span>
<span class="nv">CUDALIB</span><span class="o">=</span><span class="s2">"-L/cineca/prod/compilers/cuda/5.0.35/none/lib64 -lcudart"</span> 
<span class="nv">LIBS</span><span class="o">=</span><span class="s2">"$CUDAINC $CUDALIB -L/cineca/prod/libraries/boost/1.53.0/gnu--4.6.3/lib -lboost_thread-mt -DNGB"</span>
</pre></div>


<ul>
<li>in <code>grape.sh</code></li>
</ul>
<div class="code"><pre><span class="nv">GRAPE_LDFLAGS_</span><span class="o">=</span><span class="s1">'-L$HOME/slPack/sapporo/'</span>
<span class="nv">GRAPE_LIBS_</span><span class="o">=</span><span class="s1">'-lsapporo'</span>
</pre></div>


<ul>
<li>in <code>setup_starlab.sh.sh</code>
(if you want to compile sapporo using queues, or, load modules by hand if you want to 
compile interactively)</li>
</ul>
<div class="code"><pre>module purge
module load profile/advanced
module load gnu/4.6.3
module load boost/1.53.0--gnu--4.6.3
module load cuda
<span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/cineca/prod/compilers/cuda/5.0.35/none/lib64:/cineca/prod/libraries/boost/1.53.0/gnu--4.6.3/lib
<span class="nb">export </span>LD_LIBRARY_PATH
<span class="nb">cd</span> <span class="nv">$HOME</span>/slPack/starlab
</pre></div>


<h5>Green II HPC system @ Swinburne University</h5>
<p>Thanks to prof. Jarod Hurley I was able to test the installation of StarLab on the Green II HPC 
system at the Swinburne University. Here how to do that.    </p>
<ul>
<li>Log into the system and find yourself in the login node.</li>
<li>Clone the private repo / download the folders and unpack them like described before.</li>
<li>Then you need to log into one of the compile/test nodes from the head node: <code>ssh $USER@gstar001</code></li>
<li>load the right modules:</li>
</ul>
<div class="code"><pre>module load gcc/4.6.4
module load boost/x86_64/gnu/1.51.0-gcc4.6
module load cuda/4.0
</pre></div>


<p>You need that version of <code>gcc</code> and <code>boost</code> because of issues with boost threads in the default versions.
Just in case, check that the paths in the <code>Makefile</code> and <code>compile.h</code> agree with that shown in   <br>
<code>module show boost/x86_64/gnu/1.51.0-gcc4.6</code>
and
<code>module show cuda</code></p>
<p>Make sure you have no <code>'</code> around your path, maybe, if you need, only <code>"</code> otherwise <code>sapporo</code> won't compile.
Just in case, check that the paths in the <code>Makefile</code> and <code>compile.h</code> agree with that shown in   <br>
<code>module show boost/x86_64/gnu/1.51.0-gcc4.6</code>
and
<code>module show cuda</code></p>
<p>If you have our private version you can 
<em> <code>cp ../scripts/g2/Makefile ./</code>
</em> <code>cp ../scripts/g2/compile.sh ./</code></p>
<p>otherwise try to modify them to have:</p>
<div class="code"><pre>CXX  :<span class="o">=</span> g++
CC   :<span class="o">=</span> gcc
NVCC :<span class="o">=</span> /usr/local/cuda-4.0/bin/nvcc
CUDAINC :<span class="o">=</span> -I/usr/local/cuda-4.0/include -I/usr/local/cuda-4.0/C/common/inc 
BOOSTINC :<span class="o">=</span> -I/usr/local/x86_64/gnu/boost-1.51.0-gcc4.6
NVCCFLAGS :<span class="o">=</span> -O0 -g -D_DEBUG  -maxrregcount<span class="o">=</span>64 <span class="k">$(</span>CUDAINC<span class="k">)</span> <span class="k">$(</span>BOOSTINC<span class="k">)</span> 
</pre></div>


<p>in the <code>Makefile</code> and </p>
<div class="code"><pre><span class="nv">flags</span><span class="o">=</span>-DNGB

<span class="nv">CUDAINC</span><span class="o">=</span><span class="s2">"-I/usr/local/cuda-4.0/include -I/usr/local/cuda-4.0/C/common/inc"</span>
<span class="nv">CUDALIB</span><span class="o">=</span><span class="s2">"-L/usr/local/cuda-4.0/lib64 -L/usr/local/cuda-4.0/lib:/usr/local/cuda-4.0/C/lib"</span>
<span class="nv">CUDAFLAG</span><span class="o">=</span><span class="s2">"-lcudart"</span>
<span class="nv">BOOSTINC</span><span class="o">=</span><span class="s2">"-I/usr/local/x86_64/gnu/boost-1.51.0-gcc4.6"</span>
<span class="nv">BOOSTLIB</span><span class="o">=</span><span class="s2">"-L/usr/local/x86_64/gnu/boost-1.51.0-gcc4.6"</span>
<span class="nv">BOOSTFLAG</span><span class="o">=</span><span class="s2">"-lboost_system  -lboost_thread-mt -lpthread"</span>

g++ -O3 <span class="nv">$flags</span> -g -o test_gravity_block test_gravity_block.cpp -L. -lsapporo <span class="nv">$CUDAINC</span> <span class="nv">$CUDALIB</span> <span class="nv">$CUDAFLAG</span> <span class="nv">$BOOSTINC</span> <span class="nv">$BOOSTLIB</span> <span class="nv">$BOOSTFLAG</span>
g++ -O3 <span class="nv">$flags</span> -g -o test_gravity_N2ngb test_gravity_N2ngb.cpp -L. -lsapporo <span class="nv">$CUDAINC</span> <span class="nv">$CUDALIB</span> <span class="nv">$CUDAFLAG</span> <span class="nv">$BOOSTINC</span> <span class="nv">$BOOSTLIB</span> <span class="nv">$BOOSTFLAG</span>
</pre></div>


<p>in <code>compile.sh</code>.</p>
<p>Then run</p>
<ul>
<li><code>make clean</code></li>
<li><code>make</code></li>
<li><code>bash compile.sh</code></li>
</ul>
<p>No go the the starlab folder (<code>cd ../starlab</code>) and fix the <code>configure</code> file accordingly to this</p>
<div class="code"><pre><span class="c">#   Check all named libraries for g6_open() (GRAPE-6).</span>

    <span class="nv">grape6</span><span class="o">=</span>no

    <span class="k">for </span>gl in <span class="nv">$GRAPE_LIBS_</span>; <span class="k">do</span>
    <span class="c">##############################</span>
    <span class="c">######      g2</span>
    <span class="c">##############################</span>
    <span class="nv">CUDAINC</span><span class="o">=</span><span class="s2">"-I/usr/local/cuda-4.0/include/ -I/usr/local/cuda-4.0/C/common/inc/"</span>
    <span class="nv">CUDALIB</span><span class="o">=</span><span class="s2">"-L/usr/local/cuda-4.0/lib64 -L/usr/local/cuda-4.0/lib:/usr/local/cuda-4.0/C/lib"</span>
    <span class="nv">CUDAFLAG</span><span class="o">=</span><span class="s2">"-lcudart"</span>
    <span class="nv">BOOSTINC</span><span class="o">=</span><span class="s2">"-I/usr/local/x86_64/gnu/boost-1.51.0-gcc4.6/"</span>
    <span class="nv">BOOSTLIB</span><span class="o">=</span><span class="s2">"-L/usr/local/x86_64/gnu/boost-1.51.0-gcc4.6"</span>
    <span class="nv">BOOSTFLAG</span><span class="o">=</span><span class="s2">"-lboost_system  -lboost_thread-mt -lpthread"</span>

    <span class="nv">LIBS</span><span class="o">=</span><span class="s2">"$CUDAINC $CUDALIB $CUDAFLAG $BOOSTINC $BOOSTLIB $BOOSTFLAG -DNGB"</span>


    <span class="nv">as_ac_Lib</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">"ac_cv_lib_${gl/-l/}''_g6_open_"</span> | <span class="nv">$as_tr_sh</span><span class="sb">`</span>
</pre></div>


<p>and the <code>local/grape.sh</code> file to point to your sapporo installation.</p>
<p>If you have our version of StarLab, just copy the right files:</p>
<ul>
<li><code>cp ../scripts/g2/configure ./</code></li>
<li><code>cp ../scripts/g2/grape.sh ./local/</code></li>
</ul>
<p>Make sure again <code>grape.sh</code> points to the right folder</p>
<ul>
<li><code>./configure --without-f77 --with-qt=no</code> (if you want qt, load the modules and check the versions)</li>
<li><code>make clean &amp;&amp; make clean &amp;&amp; make clean</code></li>
<li><code>make &amp;&amp; make</code></li>
<li><code>rm ./usr/bin/*</code></li>
<li><code>make install</code></li>
</ul>
<p><strong> Troubleshooting </strong></p>
<p>If you get this error (or some other error)</p>
<div class="code"><pre>make<span class="o">[</span>2<span class="o">]</span>: Entering directory <span class="sb">`</span>/mnt/home/bziosi/slpack/starlab/src/gfx/lux<span class="s1">'</span>
<span class="s1">/bin/sh ../../../libtool --preserve-dup-deps --mode=link gcc  -g -O2  -L/usr/lib64/qt-3.3/lib -o libgfx-2.la   win.lo draw.lo draw1.lo color.lo dialog.lo mcd.lo interface.lo termio.lo utility.lo simple.lo  -I/usr/local/cuda-4.0/include -I/usr/local/cuda-4.0/C/common/inc -L/usr/local/cuda-4.0/lib64 -L/usr/local/cuda-4.0/lib:/usr/local/cuda-4.0/C/lib -lcudart -L/usr/local/x86_64/gnu/boost-1.51.0-gcc4.6 -lboost_system  -lboost_thread-mt -lpthread -DNGB</span>
<span class="s1">ar cru .libs/libgfx-2.a  win.o draw.o draw1.o color.o dialog.o mcd.o interface.o termio.o utility.o simple.o</span>
<span class="s1">ar: interface.o: No such file or directory</span>
<span class="s1">make[2]: *** [libgfx-2.la] Error 1</span>
<span class="s1">make[2]: Leaving directory `/mnt/home/bziosi/slpack/starlab/src/gfx/lux'</span>
make<span class="o">[</span>1<span class="o">]</span>: *** <span class="o">[</span>clibs23<span class="o">]</span> Error 2
make<span class="o">[</span>1<span class="o">]</span>: Leaving directory <span class="sb">`</span>/mnt/home/bziosi/slpack/starlab/src/gfx<span class="err">'</span>
make: *** <span class="o">[</span>libs<span class="o">]</span> Error 2
</pre></div>


<p>when compiling may be you can try to <code>make</code> and <code>make clean</code> some times.  <br>
Also remember that make clean is not working properly, so you need to <code>make clean</code> more than once or delete the binaries by yourself.</p>
<p>If you have errors regarding no rules for <code>libxhdyn.la</code>, probably you forgot to exclude 
some options from the configure, so run <code>configure --with-f77=no --with-qt=no</code> or try <code>configure --help</code> 
to check for other options.</p>
<h4>Additional material</h4>
<ul>
<li>Code units (coming soon...)</li>
<li>StarLab internals (really???)</li>
<li><a href="https://bitbucket.org/brunetto/slpack">Our repo</a></li>
<li><a href="http://www.science.uva.nl/sites/modesta/wiki/index.php/Starlab_tools">StarLab tools wiki</a></li>
</ul></div>
    </div>
    </div>
    
        <ul class="pager">
            <li class="previous">
                <a href="nvidia-drivers.html" rel="prev">← Previous post</a>
            </li>
            <li class="next">
                <a href="agn-for-dummies.html" rel="next">Next post →</a>
            </li>
        </ul>

        
        


    

    </article>

    </div>
    </div>
    <!--End of body content-->
</div>
<div class="footerbox">
    Contents © 2014 <a href="mailto:brunetto.ziosi@gmail.com">brunetto</a> - <a href="https://plus.google.com/117554238100031566866?rel=author">G+ Profile</a> - Powered by <a href="http://nikola.ralsina.com.ar">Nikola</a>
</div>

            <script src="../assets/js/jquery-1.10.2.min.js" type="text/javascript"></script>
            <script src="../assets/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="../assets/js/jquery.colorbox-min.js" type="text/javascript"></script>


    
<!-- Social buttons -->
<div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
<a class="addthis_button_more">Share</a>
<ul><li><a class="addthis_button_facebook"></a>
</li><li><a class="addthis_button_google_plusone_share"></a>
</li><li><a class="addthis_button_linkedin"></a>
</li><li><a class="addthis_button_twitter"></a>
</li></ul>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script>
<!-- End of social buttons -->


    <script type="text/javascript">jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});
    $(window).on('hashchange', function(){
        if (location.hash && $(location.hash)[0]) {
            $('body').animate({scrollTop: $(location.hash).offset().top - $('#navbar').outerHeight(true)*1.2 }, 1);
        }
    });
    $(document).ready(function(){$(window).trigger('hashchange')});
    </script>
    
    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51923245-1', 'brunettoziosi.eu');
  ga('send', 'pageview');

</script>

</body>
</html>