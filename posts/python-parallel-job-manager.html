<!DOCTYPE html><html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta charset="utf-8">
    <meta name="author" content="brunetto">
    <title>Python parallel job manager | for future reference...</title>
    
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
   tex2jax: {
       inlineMath: [ ['$','$'], ["\\(","\\)"] ],
       displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
   },
   displayAlign: 'left', // Change this to 'center' to center equations.
   "HTML-CSS": {
       styles: {'.MathJax_Display': {"margin": 0}}
   }
});
</script>

            <link href="../assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
            <link href="../assets/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css">
        <link href="../assets/css/rst.css" rel="stylesheet" type="text/css">
        <link href="../assets/css/code.css" rel="stylesheet" type="text/css">
        <link href="../assets/css/colorbox.css" rel="stylesheet" type="text/css">
        <link href="../assets/css/theme.css" rel="stylesheet" type="text/css">
      <link rel="canonical" href="posts/python-parallel-job-manager.html">
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js" type="text/javascript"></script>
    <![endif]-->
            <link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">

    





    <link href="https://plus.google.com/117796240971605586205" rel="publisher">
</head>
<body>
<!-- Menubar -->
<div class="navbar navbar-fixed-top" id="navbar">
    <div class="navbar-inner">
        <div class="container">

        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </a>

            <a class="brand" href=".">
            for future reference...
            </a>
            <!-- Everything you want hidden at 940px or less, place within here -->
            <div class="nav-collapse collapse">
                <ul class="nav">
                    
                <li><a href="../stories/about.html">About</a>
                </li><li><a href="../index.html">Blog</a>
                </li><li><a href="../stories/index.html">SiteIndex</a>
                </li><li><a href="../archive.html">Archives</a>
                </li><li><a href="../categories/index.html">Tags</a>
                </li><li><a href="../rss.xml">RSS</a>

                </li></ul>
                    
<!-- Custom search with google-->
<form id="search" action="http://google.com/search" method="get" class="navbar-form pull-left">
<input type="hidden" name="q" value="site:./">
<input type="text" name="q" maxlength="255" results="0" placeholder="Search">
</form>
<!-- End of custom search -->

                <ul class="nav pull-right">
                
                
                </ul>
            </div>
        </div>
    </div>
</div>
<!-- End of Menubar -->
<div class="container-fluid" id="container-fluid">
    <!--Body content-->
    <div class="row-fluid">
    <div class="span2"></div>
    <div class="span8">
    
    <article class="postbox post-text">
    <div class="h-entry" itemscope="itemscope" itemtype="http://schema.org/Article">
    
    <h1 class="p-name" itemprop="headline name">Python parallel job manager</h1>

    <hr>
    <small>
        Posted: <time class="published dt-published" datetime="2011-11-04T00:00:00+00:00" itemprop="datePublished">2011-11-04 00:00</time>
        

		
          |  
        More posts about 
    <span itemprop="keywords">
        <a class="tag p-category" href="../categories/astrophysics.html"><span class="badge badge-info">astro/physics</span></a>
        <a class="tag p-category" href="../categories/code.html"><span class="badge badge-info">code</span></a>
        <a class="tag p-category" href="../categories/computer.html"><span class="badge badge-info">Computer</span></a>
        <a class="tag p-category" href="../categories/master-thesis.html"><span class="badge badge-info">Master Thesis</span></a>
        <a class="tag p-category" href="../categories/python.html"><span class="badge badge-info">Python</span></a>
        <a class="tag p-category" href="../categories/imported.html"><span class="badge badge-info">imported</span></a>
    </span>


          |  
		
    </small>
    <hr>
    <div class="e-content" itemprop="articleBody text">
    <div><p>The final version of the code for my master thesis was the most embarrassing parallel code you can think... just a serial code to be run on different slices of the dataset. I choose this solution because it permits to manage the different resources (memory, processors, ...) on the different machines available without any restriction. Moreover, this solution has no communication between the processes, with better performances and all the processes are independent, so it minimize the damages due to any failure.  <br>
<!-- TEASER_END --></p>
<p>At this step, however, I didn't know how to manage the different processes in a comfortable way. 
My requirements were:    </p>
<ul>
<li>to start only one process that will take care of starting the right code on the right data-slice</li>
<li>the possibility to start "n" processes depending on the number of processors and memory available (in the actual code this is done by hand)</li>
<li>the code should be able to start a new process when one of the previous processes end</li>
</ul>
<p>Hereafter I expose and comment the complete "template" for this Python code as I wrote it.    </p>
<div class="code"><pre><span class="c">#!/bin/env python</span>

<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>

<span class="sd">"""This script starts n_procs processes that in parallel take the</span>
<span class="sd">number of the data file from a common queue and with a loop apply the</span>
<span class="sd">analysys code to the data starting it with a bash command using Popen</span>
<span class="sd">"""</span>
</pre></div>


<p>The first line is the declaration of the interpreter to be used for this script, in this case Python. After that we import some libraries and modules used in this code. The last lines, inside the triple quotes, are the documentation string of the code. Python in fact has a self-doc system that can be used to understand what a piece of code does and how it works.    </p>
<div class="code"><pre><span class="n">n_procs</span> <span class="o">=</span> <span class="mi">10</span> <span class="c"># number of processes to be started</span>
<span class="n">file_1</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">file_2</span> <span class="o">=</span>  <span class="s">"mill2_fof_sorted.h5"</span>
<span class="n">m_factor</span> <span class="o">=</span> <span class="mi">1</span>    <span class="c"># How many random more than data</span>
<span class="n">start_slice</span> <span class="o">=</span> <span class="mi">0</span> 
<span class="n">end_slice</span> <span class="o">=</span> <span class="mi">99</span>
</pre></div>


<p>Here we set some parameters: the number of processes to start (set by hand), the two files to use in the analysis, how many random particles we use more than the data particles and the limits in the data slice to analyze. In this case we want to correlate the data in <code>mill2_fof_sorted.h5</code> with the data contained in the slices between slice 0 and slice 99. file_1 will be replaced after with the right name. This analysis will be carry out using 10 processes at each time. As a process end the code will take care of starting a new process.    </p>
<div class="code"><pre><span class="k">def</span> <span class="nf">starter</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
    <span class="sd">"""Start the code processes one after the other"""</span>
    <span class="k">while</span> <span class="nb">input</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">item</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">file_1</span> <span class="o">=</span> <span class="s">"mill2sort-"</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>       
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">"/opt/epd-7.0-2-rh5-x86_64/bin/python -u </span><span class="se">\</span>
<span class="s">            ../serial.py --file_1 "</span><span class="o">+</span><span class="n">file_1</span><span class="o">+</span><span class="s">" --file_2 "</span><span class="o">+</span><span class="n">file_2</span><span class="o">+</span>\
        <span class="s">" -l 400 -n 0 --m_factor "</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">m_factor</span><span class="p">)</span><span class="o">+</span><span class="s">" </span><span class="se">\</span>
<span class="s">            --slicing --log ../logs/"</span><span class="o">+</span><span class="n">file_1</span><span class="o">+</span><span class="s">"-"</span><span class="o">+</span><span class="n">file_2</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
        <span class="n">pid_cmd</span> <span class="o">=</span> <span class="s">'echo "'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">'" &amp;gt;&amp;gt; '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span><span class="o">+</span><span class="s">'.log'</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">pid_cmd</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">"Popen/os.system not done, exit..."</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
</pre></div>


<p>This piece of code defines the function that will start the processes. It's called <code>started</code> and it takes <code>input</code> and <code>output</code> as arguments. These are two "queue objects", they can be filled and emptied in the FIFO way. The starter has a while loop that check if the queue is empty, if not it takes the next elements. This is the number of the slice to be used by the analysis code and with it we build the name of the file to be opened. <code>cmd</code> is the string we use to start the analysis code with some options (<code>serial.py</code> is the actual "cool" name I gave to my code!:P).  <br>
The <code>try-exept</code> syntax is the particular Python way to manage the possible errors in the execution, giving the ability to the programmer to handle possible problems (exceptions).  <br>
So we catch the pid of the starter and save into its log the number of sliced it start and pass to the <code>Popen</code> (process-open) command the string to start the analysis process telling it to wait the end of the process. If something goes wrong we print that there were some errors and exit the code in a clean way.    </p>
<div class="code"><pre><span class="k">def</span> <span class="nf">fill_queue</span><span class="p">(</span><span class="n">task_queue</span><span class="p">,</span> <span class="n">start_slice</span><span class="p">,</span> <span class="n">end_slice</span><span class="p">):</span>
    <span class="sd">"""Fill the queue"""</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_slice</span><span class="p">,</span> <span class="n">end_slice</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">task_queue</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">task_queue</span>
</pre></div>


<p>This functions only fill the queue with the number of the sliced to be used.    </p>
<div class="code"><pre><span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">proc</span><span class="p">):</span>
    <span class="sd">"""Check for processes status"""</span>
    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span><span class="o">==</span><span class="bp">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">'alive'</span>
    <span class="k">elif</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span><span class="o">==</span><span class="bp">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">'dead'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>
</pre></div>


<p>This piece of code check the status (dead or alive) of one process (<code>proc</code> is the process object... yeah, in Python everything is an object!)    </p>
<div class="code"><pre><span class="n">input_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
<span class="n">output_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">input_queue</span> <span class="o">=</span> <span class="n">fill_queue</span><span class="p">(</span><span class="n">input_queue</span><span class="p">,</span> <span class="n">start_slice</span><span class="p">,</span> <span class="n">end_slice</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"Queue not filled, exit..."</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

<span class="n">procs</span> <span class="o">=</span> <span class="p">[]</span>    <span class="c"># processes container</span>
</pre></div>


<p>Now we create the empty queues and (try to) fill them, and create the container for the processes objects.    </p>
<div class="code"><pre><span class="k">try</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_procs</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"Process loop "</span><span class="p">,</span> <span class="n">i</span>
        <span class="n">procs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">starter</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">input_queue</span><span class="p">,</span> <span class="n">output_queue</span><span class="p">)))</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"Creating processes not complete, exit..."</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">:</span>
        <span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"Start processes not complete, exit..."</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">procs</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"Process "</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span><span class="s">" @ "</span> <span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="s">" is "</span><span class="p">,</span> <span class="n">status</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>


<p>This is the central part of this code: we create the processes objects and put them into the container, start them and check for their status. Everything is inside the <code>try-except</code> environment to check for possible errors and handle them.  <br>
In practice we start "n" processes and every process take the number of a slice from the queue and use it to start the analysis code, waiting for its end. When the analysis is finished it takes another number from the queue and start again the code. When the queue is empty everything is automatically switched off.  <br>
Future improvements will consider the automatically detection of the hardware resources and the possibility to mail the status of the code.</p></div>
    </div>
    </div>
    
        <ul class="pager">
            <li class="previous">
                <a href="loadleveler-quick-howto.html" rel="prev">← Previous post</a>
            </li>
            <li class="next">
                <a href="phd-question-1-m.html" rel="next">Next post →</a>
            </li>
        </ul>

        
        


    

    </article>

    </div>
    </div>
    <!--End of body content-->
</div>
<div class="footerbox">
    Contents © 2015 <a href="mailto:brunetto.ziosi@gmail.com">brunetto</a> - <a href="https://plus.google.com/117554238100031566866?rel=author">G+ Profile</a> - Powered by <a href="http://nikola.ralsina.com.ar">Nikola</a>
</div>

            <script src="../assets/js/jquery-1.10.2.min.js" type="text/javascript"></script>
            <script src="../assets/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="../assets/js/jquery.colorbox-min.js" type="text/javascript"></script>


    
<!-- Social buttons -->
<div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
<a class="addthis_button_more">Share</a>
<ul><li><a class="addthis_button_facebook"></a>
</li><li><a class="addthis_button_google_plusone_share"></a>
</li><li><a class="addthis_button_linkedin"></a>
</li><li><a class="addthis_button_twitter"></a>
</li></ul>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script>
<!-- End of social buttons -->


    <script type="text/javascript">jQuery("a.image-reference").colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});
    $(window).on('hashchange', function(){
        if (location.hash && $(location.hash)[0]) {
            $('body').animate({scrollTop: $(location.hash).offset().top - $('#navbar').outerHeight(true)*1.2 }, 1);
        }
    });
    $(document).ready(function(){$(window).trigger('hashchange')});
    </script>
    
    
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51923245-1', 'brunettoziosi.eu');
  ga('send', 'pageview');

</script>

</body>
</html>