<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    Cosmological simulations #3: force calculation! // Post It!
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="Brunetto Ziosi">

  <meta property="og:title" content="Cosmological simulations #3: force calculation!" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="http://brunettoziosi.eu/posts/cosmological-simulations-3-force-calculation/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="http://brunettoziosi.eu/css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.svg">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Post It!" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

    <h1 class="brand-title">Post It!</h1>
    <h2 class="brand-tagline">Sticky digital notes
    </br>stuck on the Web!üòÉ</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="http://brunettoziosi.eu">Home</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/posts/">Blog</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/pages/curriculum-vitae/">CV</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/pages/">Pages</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="http://plus.google.com/&#43;BrunettoZiosi" target="_blank"><i class='fa fa-google-plus'></i></a>
        
      
        
        <a href="http://www.linkedin.com/in/brunettoziosi" target="_blank"><i class='fa fa-linkedin'></i></a>
        
      
        
        <a href="http://www.github.com/brunetto" target="_blank"><i class='fa fa-github'></i></a>
        
      
        
        <a href="http://www.facebook.com/brunettoziosi" target="_blank"><i class='fa fa-facebook'></i></a>
        
      
        
        <a href="http://www.twitter.com/brunettoziosi" target="_blank"><i class='fa fa-twitter'></i></a>
        
      
        
        <a href="https://instagram.com/elbrunz/" target="_blank"><i class='fa fa-instagram'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
		    <div id="toc" class="pure-u-1 pure-u-md-1-4">
				<small class="toc-label">Contents</small>
		   	 	<nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#direct-summation-pp-method:b4d5cf4d6678e662a616552bea757490">Direct summation: PP method</a></li>
<li><a href="#tree-method:b4d5cf4d6678e662a616552bea757490">Tree method</a></li>
<li><a href="#fast-multipole-method:b4d5cf4d6678e662a616552bea757490">Fast multipole method</a></li>
<li><a href="#particle-mesh-method:b4d5cf4d6678e662a616552bea757490">Particle-mesh method</a></li>
<li><a href="#adaptive-mesh-refinement:b4d5cf4d6678e662a616552bea757490">Adaptive-mesh refinement</a></li>
<li><a href="#p3m-particle-particle-particle-mesh:b4d5cf4d6678e662a616552bea757490">P3M: particle-particle+particle-mesh</a></li>
<li><a href="#tree-pm-tpm:b4d5cf4d6678e662a616552bea757490">Tree+PM: TPM</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
		    </div>
		    
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/posts/cosmological-simulations-3-force-calculation/">Cosmological simulations #3: force calculation!</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>13</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Nov</span> <span class="post-date-year">2011</span>
            	</span>
            	
            
            	
            		<span class="post-author-single">By <a class="post-author" href="http://brunettoziosi.eu" target="">Brunetto Ziosi</a></span>
            		




            	
            

			
			
				<div class="post-categories">
				
					<a class="post-category post-category-research" href="http://brunettoziosi.eu/categories/research">Research</a>
				
					<a class="post-category post-category-post" href="http://brunettoziosi.eu/categories/post">Post</a>
				
				</div>
			

			
		    	<div class="social-sharing">
	<a class="share-button-facebook" onClick="return popupShare(this.href);" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-3-force-calculation%2f" target="_blank"><i class="fa fa-facebook"><span>Like</span></i></a>
	<a class="share-button-google-plus" onClick="return popupShare(this.href);" href="https://plus.google.com/share?url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-3-force-calculation%2f" target="_blank"><i class="fa fa-google-plus"><span>Google +1</span></i></a>
	<a class="share-button-linkedin" onClick="return popupShare(this.href);" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-3-force-calculation%2f&title=Cosmological%20simulations%20%233%3a%20force%20calculation%21&summary=%3cp%3eIn%20the%20previous%20posts%20we%20wrote%20about%20cosmological%20simulations%2c%20why%20we%20need%20them%2c%20how%20they%20are%20performed%20and%20which%20are%20the%20important%20things%20to%20care%20about.%0aNow%20we%20are%20ready%20to%20learn%20the%20algorithms%20developed%20to%20compute%20gravitational%20forces%20between%20the%20particles.%3c%2fp%3e%0a}&source=Post%20It%21" target="_blank"><i class="fa fa-linkedin"><span>Share on LinkedIn</span></i></a>
	<a class="share-button-twitter" onClick="return popupShare(this.href);" href="http://twitter.com/share?text=Cosmological%20simulations%20%233%3a%20force%20calculation%21&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-3-force-calculation%2f" target="_blank"><i class="fa fa-twitter"><span>Tweet</span></i></a>	
</div>
		    

			

            

<p>In the previous posts we wrote about cosmological simulations, why we need them, how they are performed and which are the important things to care about.
Now we are ready to learn the algorithms developed to compute gravitational forces between the particles.</p>

<h3 id="direct-summation-pp-method:b4d5cf4d6678e662a616552bea757490">Direct summation: PP method</h3>

<p>The raw approach is to calculate forces between all pairs in the simulation. This works well for less than $10^3$. The number of pairs, and therefore the computational time, scales as $N^2$, so this method that is usually unacceptable given the number of particles in a simulation.<br />
It&rsquo;s difficult to implement periodic boundary conditions in this method (because you have to manage it by hand) and the only convenient way to do this is to use the Ewald summation.<br />
This method is mostly used to test other methods.</p>

<h3 id="tree-method:b4d5cf4d6678e662a616552bea757490">Tree method</h3>

<p>The disadvantage of the pp-method comes from having to compute the interaction of any new particle with all the others. The tree method, on the contrary, approximate the force of a distant group of particles with the force exerted by only one particle, in the center of mass of the group, with mass equal the total mass of the group. In this way the computation scales as $N\log N$.<br />
To create the groups the particles are divided and arranged in a tree structure, that is, the initial volume is divided, and every resulting volume divided again. This procedure goes on until in the resulting volumes there&rsquo;s only one particle. In this situation it&rsquo;s very important the &ldquo;cell acceptance criterion&rdquo; that decide whether or not a cell is far enough to be used as it is or if it has to be divided into its subvolumes.<br />
The accuracy and the speed of this method can be improved storing some information about the particles in the volumes (such as moments of the mass distribution, usually the quadrupole).<br />
Moreover, close particles can share information about distant groups because the force is very similar, and the tree can be parallelized efficiently. However, it&rsquo;s not so easy to consider periodic boundary conditions.</p>

<h3 id="fast-multipole-method:b4d5cf4d6678e662a616552bea757490">Fast multipole method</h3>

<p>This method is an improved version of the tree method. It is based on including higher moments of the mass distribution in cells and some other optimizations. This method has a computational costs which scales as $N$.</p>

<p>However all these method has problems with the open boundary conditions and it&rsquo;s difficult to adapt it to the cosmological needs. An extension of the tree method with explicit momentum conservation has been also developed.</p>

<h3 id="particle-mesh-method:b4d5cf4d6678e662a616552bea757490">Particle-mesh method</h3>

<p>This is the first method used extensively for cosmological simulations and the first used for simulation with order of $10^5$ particles. The PM method solve the Poisson equation (partial differential equation that links the gravitational field with the mass distribution) in the Fourier space, where it is a simple algebraic equation, using the FFT (Fast Fourier Transform) routine to change from coordinate space to the Fourier space and viceversa&nbsp;. FFT requires to sample the functions at uniformly spaced points and here we use a grid (mesh). We compute density at the grid points using weight functions on the particles representing the density and velocity fields.<br />
The use of Fourier methods automatically include periodic boundary conditions without no additional effort (because of the nature of periodic function in the Fourier space) and the use of the mesh automatically soften the force at small scales (because of the interpolation needed to compute the gravitational field on the grid) but it underestimate the force at scales larger (toughly up to 3 times) than the softening length.<br />
This method is parallelized using parallel FFT and dividing the volume among the processors.<br />
Softening at the mesh scale give collisionless evolution but the code cannot resolve structure at scales smaller than the mesh scale, moreover the mesh makes the force anisotropic at small scales. This happens because the grid points don&rsquo;t sample very well the filed on such small scales.</p>

<h3 id="adaptive-mesh-refinement:b4d5cf4d6678e662a616552bea757490">Adaptive-mesh refinement</h3>

<p>In AMR methods the mesh is refined in high density regions using a finer grid, but it&rsquo;s important to pay attention to the conservation of momentum and angular momentum switching from a grid to another.</p>

<h3 id="p3m-particle-particle-particle-mesh:b4d5cf4d6678e662a616552bea757490">P3M: particle-particle+particle-mesh</h3>

<p>The idea is to add a correction to the force calculated with the PM method by using the PP method on the closest particles. The correction is assumed to be isotropic and depend only upon the distance. Usually it&rsquo;s considered a distance of the order of 2 times the internode mesh distance. This method has been parallelized but with some problems, also because load balancing is quite difficult to achieve.</p>

<p>Some other problems are:</p>

<ul>
<li>the correction to the force is isotropic but the PM method has anisotropies at small scales</li>
<li>the correction is at scales up to 2 times the grid scale but the PM method underestimate the force on scales larger than these</li>
<li>the refined interparticle softening is at scales smaller than the interparticle separation and this can lead to two-body scattering and relaxation</li>
<li>P3M simulations slow down at late times when the distribution of particles becomes highly clustered because the short range force dominate the compute operations<br /></li>
</ul>

<h3 id="tree-pm-tpm:b4d5cf4d6678e662a616552bea757490">Tree+PM: TPM</h3>

<p>Some hybrid codes has been developed trying to combine the PM and the Tree methods:</p>

<ul>
<li>The Grid of Trees PM (GOTPM)replaces the PP part of P3M with a local tree in each region. This resolve only the last problem of the P3M.</li>
<li>TPM correct the short range force only if the particle is in a highly dense region and with a tree to compute the forces.</li>
<li>TreePM divide the force in long-range and short-range instead of correcting the PM force at a certain scale, greater than that of the P3M. The short-range forces are calculated with a global tree.</li>
<li>The Adaptive TreePM (ATreePM) try to resolve the two-body relaxation and scattering using an adaptive softening length, determined by the local density. To ensure momentum conservation force is simmetrized for particles closer than the softening length. The softening correspond to consider the particles with a density profile and not only mass points and if the softening length is different for two close particles, the force they feel is different between them. This happens &nbsp;because particle A feel a force due to its entire mass and a certain fraction of particle B mass, but particle B feels a force due to its own mass and a different fraction of the mass of particle A. In this case the forces are symmetrized taking the mean of the two forces.</li>
</ul>

<p>To compare different methods we can consider:</p>

<ul>
<li>The dynamic range, that is the range of scales over which the force is computed reliably. Usually the limit is at small scales rather than at large scales.</li>
<li>The code should integrate the equation of motion in a reproducible way and momentum should be conserved.</li>
<li>The code should be efficient and run with the minimum possible time</li>
<li>Requirement of memory and other resources.</li>
</ul>

<p><em>References</em>:</p>

<ul>
<li><a href="http://www.ias.ac.in/currsci/apr102005/1088.pdf" target="_blank" title="J.S. Bagla, Cosmological N-body simulation: Techniques, scope and status">J. S. Bagla, Cosmological N-body simulation: Techniques, scope and status</a></li>
<li><a href="http://adsabs.harvard.edu/abs/1991ComPh...5..164B" target="_blank" title="J.S. Bagla and T. Padmanabham, Cosmological N-body simulations">J.S. Bagla and T. Padmanabham, Cosmological N-body simulations</a></li>
</ul>

	
			
		    	<div class="social-sharing">
	<a class="share-button-facebook" onClick="return popupShare(this.href);" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-3-force-calculation%2f" target="_blank"><i class="fa fa-facebook"><span>Like</span></i></a>
	<a class="share-button-google-plus" onClick="return popupShare(this.href);" href="https://plus.google.com/share?url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-3-force-calculation%2f" target="_blank"><i class="fa fa-google-plus"><span>Google +1</span></i></a>
	<a class="share-button-linkedin" onClick="return popupShare(this.href);" href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-3-force-calculation%2f&title=Cosmological%20simulations%20%233%3a%20force%20calculation%21&summary=%3cp%3eIn%20the%20previous%20posts%20we%20wrote%20about%20cosmological%20simulations%2c%20why%20we%20need%20them%2c%20how%20they%20are%20performed%20and%20which%20are%20the%20important%20things%20to%20care%20about.%0aNow%20we%20are%20ready%20to%20learn%20the%20algorithms%20developed%20to%20compute%20gravitational%20forces%20between%20the%20particles.%3c%2fp%3e%0a}&source=Post%20It%21" target="_blank"><i class="fa fa-linkedin"><span>Share on LinkedIn</span></i></a>
	<a class="share-button-twitter" onClick="return popupShare(this.href);" href="http://twitter.com/share?text=Cosmological%20simulations%20%233%3a%20force%20calculation%21&url=http%3a%2f%2fbrunettoziosi.eu%2fposts%2fcosmological-simulations-3-force-calculation%2f" target="_blank"><i class="fa fa-twitter"><span>Tweet</span></i></a>	
</div>
		    

			
				<div class="tags-list">
					<span class="dark-red">Tags</span><span class="decorative-marker">//</span>
					
	                <a class="post-tag post-tag-astro/physics" href="http://brunettoziosi.eu/tags/astro/physics">astro/physics</a>,
	                
	                <a class="post-tag post-tag-cosmic-structure" href="http://brunettoziosi.eu/tags/cosmic-structure">cosmic structure</a>,
	                
	                <a class="post-tag post-tag-cosmology" href="http://brunettoziosi.eu/tags/cosmology">Cosmology</a>,
	                
	                <a class="post-tag post-tag-phd" href="http://brunettoziosi.eu/tags/phd">PhD</a>,
	                
				</div>
			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="/posts/cosmological-simulations-4-moving-the-particles/">Cosmological simulations: #4: Moving the particles!</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/posts/cosmological-simulations-7-limitations-and-some-considerations/">Cosmological simulations #7: Limitations and some considerations</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
		</ul>
	</div>
	<p>&copy; 2015 
	<a href="https://plus.google.com/117554238100031566866?rel=author">Brunetto Ziosi</a>. All rights reserved. </br>
	Theme by <a href="https://github.com/tmaiaroto/hugo-redlounge">Tom Maiaroto</a>, Generated (with ‚ù§) using <a href="http://gohugo.io/">Hugo.</a></p>
</div>

    </div>
  </div>
	

	
		<script type="text/javascript">
			function popupShare(url) {
				window.open(url, '_blank', 'scrollbars,resizable,height=525,width=600');
				return false;
			}
		</script>
	

  
  <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML&delayStartupUntil=configured" type="text/javascript"></script>
    <script type="text/javascript">
    
    MathJax.Hub.Config({
      tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js"]
      }
    });
    MathJax.Hub.Queue(function() {
      $(MathJax.Hub.getAllJax()).map(function(index, elem) {
        return(elem.SourceElement());
      }).parent().addClass('has-jax');
    });
    MathJax.Hub.Configured();
    </script>
</body>
</html>